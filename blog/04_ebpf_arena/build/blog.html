<!DOCTYPE html> 
<html lang='en-US' xml:lang='en-US'> 
<head><title>eBPF Arena: A Tutorial</title> 
<meta charset='utf-8' /> 
<meta content='TeX4ht (https://tug.org/tex4ht/)' name='generator' /> 
<meta content='width=device-width,initial-scale=1' name='viewport' /> 
<link href='blog.css' rel='stylesheet' type='text/css' /> 
<meta content='blog.tex' name='src' /> 
</head><body>
   <div class='maketitle'>
                                                                  

                                                                  
                                                                  

                                                                  

<h2 class='titleHead'>eBPF Arena: A Tutorial</h2>
<div class='author'><span class='cmr-12'>Farbod Shahinfar</span></div><br />
<div class='date'><span class='cmr-12'>February 25, 2025</span></div>
   </div> <p><span id='textcolor1'><span class='cmr-9'>Estimated reading time: 10 minutes</span></span></p>
                                                                  

                                                                  

                                                                  

                                                                  
                                                                  

                                                                  
<!-- l. 18 --><p class='indent'>   As part of my research, I spend time learning about eBPF. Recently, I have been
busy exploring <span class='cmti-10'>Arena </span>— a new eBPF API that enables programs to allocate memory
pages; similar functionality as <span class='cmtt-10'>mmap </span>and <span class='cmtt-10'>munmap</span> <span class='cite'>[<a href='#Xarenapatch'>11</a>]</span>.
</p><!-- l. 23 --><p class='indent'>   The eBPF community is doing a great job documenting the system and
writing tutorials. I felt I could contribute to this effort by writing about
Arena.
</p>
   <h3 class='sectionHead' id='introduction'><span class='titlemark'>1   </span> <a id='x1-10001'></a>Introduction</h3>
<!-- l. 34 --><p class='noindent'>The Arena is a new MAP type (<span class='cmtt-10'>BPF_MAP_TYPE_ARENA</span>) available to eBPF programs
since kernel version 6.9. This map is semantically different than previous ones. Unlike
data-structure MAPs (e.g., hash, array, bloom, stack, …) Arena provides a direct
access to the kernel memory instead of abstracting it away. It increases the programs
expressivity and enables them to implement their own data-structures on-demand
(e.g, a specific type of tree).
</p><!-- l. 42 --><p class='indent'>   Three use-cases have been named for the Arena in the introduction message <span class='cite'>[<a href='#Xarenapatch'>11</a>]</span>
sent along its patch to the Linux mailing list. I summarize them below:
</p>
     <ul class='itemize1'>
     <li class='itemize'>User-space can use Arena’s memory to implement its own data-structures
     (it is a normal memory region), while the memory is visible to eBPF
     programs  which  can  implement  a  fast-path  for  operations  like  packet
     processing.
     </li>
     <li class='itemize'>Arena can be used as a communication channel between an eBPF and a
     user-space program.
     </li>
     <li class='itemize'>Arena can be used as a heap of memory for the eBPF program</li></ul>
<!-- l. 54 --><p class='noindent'>My understanding from these use-cases is that Arena provides access to raw pages of
memory shareable among eBPF programs and user-space. Each can decide to use it
as they see fit with their own responsibility. It is unlike other types of data-structure
MAPs that enforce certain constraints such as fixed key and value sizes, or limiting
the operations to lookup and update.
</p><!-- l. 60 --><p class='indent'>   In this tutorial, I explore Arena’s API, and provide some examples using it. I
hope this document helps others explore Arena and facilitate its development. The
example codes in this text are shared with you at <a href='https://github.com/bpf-endeavor/ebpf-arena-tutorial' target='_blank'>this GitHub repository</a>. I’ve only
shared excerpts from the codes — The parts I thought was important. You may find
and read the full examples in the repository.
                                                                  

                                                                  
</p><!-- l. 68 --><p class='noindent'>
</p>
   <h3 class='sectionHead' id='arenas-api'><span class='titlemark'>2   </span> <a id='x1-20002'></a>Arena’s API</h3>
<!-- l. 70 --><p class='noindent'>
</p>
   <h4 class='subsectionHead' id='declare-a-map'><span class='titlemark'>2.1   </span> <a id='x1-30002.1'></a>Declare a MAP</h4>
<!-- l. 71 --><p class='noindent'>A program can declare the Arena MAP similar to other MAPs. See Listing <a href='#-example-of-using-arena-map'>1<!-- tex4ht:ref: lst:map_ex  --></a> for an
example. Here are some notes to keep in mind. The key size and value sizes must be
zero. The “<span class='cmtt-10'>max_entries</span>” field defines the maximum number of pages for the map,
and must be non-zero. As any other map, the maximum size is limited to 4 GB. At
the time of writing this text, Arena map declaration supports three flags <span class='cite'>[<a href='#Xarena_source'>4</a>]</span>:
</p>
     <ul class='itemize1'>
     <li class='itemize'><span class='cmtt-10'>BPF_F_MMAPABLE</span>:  Always  required.  Indicates  the  map  should  support
     memory mapping.
     </li>
     <li class='itemize'><span class='cmtt-10'>BPF_F_SEGV_ON_FAULT</span>: The user-space program will receive a <span class='cmtt-10'>SEGFAULT</span>
     signal if the memory is not mapped by the eBPF program (e.g., out of
     range access on a list created by the eBPF program).
     </li>
     <li class='itemize'><span class='cmtt-10'>BPF_F_NO_USER_CONV</span>: The memory region is private to the eBPF program
     and user-space program will not access it. This allows the JIT to perform
     optimizations avoiding address space casting (more about it later).</li></ul>
<!-- l. 88 --><p class='noindent'><span id='textcolor2'>note: The <span class='cmitt-10'>BPF_F_MMAPABLE </span>must always be present.</span>
                                                                  

                                                                  
</p><!-- l. 92 --><p class='noindent' id='-example-of-using-arena-map'><a id='x1-3016r1'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb1'><a id='x1-3007r1'></a><span id='textcolor3'><span class='cmtt-10'>struct</span></span><span id='textcolor4'><span class='cmtt-10'> </span></span><span class='cmtt-10'>{</span> 
<a id='x1-3009r2'></a><span id='textcolor5'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>__uint(type,</span><span id='textcolor6'><span class='cmtt-10'> </span></span><span class='cmtt-10'>BPF_MAP_TYPE_ARENA);</span> 
<a id='x1-3011r3'></a><span id='textcolor7'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>__uint(map_flags,</span><span id='textcolor8'><span class='cmtt-10'> </span></span><span class='cmtt-10'>BPF_F_MMAPABLE);</span> 
<a id='x1-3013r4'></a><span id='textcolor9'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>__uint(max_entries,</span><span id='textcolor10'><span class='cmtt-10'> </span></span><span id='textcolor11'><span class='cmtt-10'>2</span></span><span class='cmtt-10'>);</span><span id='textcolor12'><span class='cmtt-10'> </span></span><span id='textcolor13'><span class='cmitt-10'>/* number of pages */</span></span> 
<a id='x1-3015r5'></a><span class='cmtt-10'>}</span><span id='textcolor14'><span class='cmtt-10'> </span></span><span class='cmtt-10'>arena</span><span id='textcolor15'><span class='cmtt-10'> </span></span><span class='cmtt-10'>SEC(</span><span id='textcolor16'><span class='cmtt-10'>".maps"</span></span><span class='cmtt-10'>);</span></pre>
<figcaption class='caption'><span class='id'>Listing 1:</span><span class='content'>Example of using Arena map.</span></figcaption><!-- tex4ht:label?: x1-3016r1  -->
                                                                  

                                                                  
</figure>
<h4 class='subsectionHead' id='helper-functions'><span class='titlemark'>2.2   </span> <a id='x1-40002.2'></a>Helper functions</h4>
<!-- l. 104 --><p class='noindent'>Normal eBPF MAP helpers such as “<span class='cmtt-10'>bpf_map_lookup_elem</span>” are not defined for
Arena <span class='cite'>[<a href='#Xarena_source'>4</a>]</span>. Instead the following pair of functions are available: </p>
     <ul class='itemize1'>
     <li class='itemize'><span class='cmtt-10'>bpf_arena_alloc_pages</span>: Allocates a memory page
     </li>
     <li class='itemize'><span class='cmtt-10'>bpf_arena_free_pages</span>: Frees the memory page</li></ul>
<!-- l. 112 --><p class='noindent'>These functions are defined using kfunc <span class='cite'>[<a href='#Xeunomia_kfunc'>3</a>, <a href='#Xebpf_docs_kfunc'>2</a>]</span>. As required by kfunc subsystem, you
should declare the signature of these helpers in your eBPF program to use these
functions.
                                                                  

                                                                  
</p><!-- l. 116 --><p class='noindent' id='-functions-operating-on-arena-map'><a id='x1-4013r2'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb2'><a id='x1-4006r1'></a><span id='textcolor17'><span class='cmtt-10'>void</span></span><span id='textcolor18'><span class='cmtt-10'> </span></span><span class='cmtt-10'>__arena</span><span id='textcolor19'><span class='cmtt-10'>*</span></span><span id='textcolor20'><span class='cmtt-10'> </span></span><span id='textcolor21'><span class='cmtt-10'>bpf_arena_alloc_pages</span></span><span class='cmtt-10'>(</span><span id='textcolor22'><span class='cmtt-10'>void</span></span><span id='textcolor23'><span class='cmtt-10'> </span></span><span id='textcolor24'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>map,</span><span id='textcolor25'><span class='cmtt-10'> </span></span><span id='textcolor26'><span class='cmtt-10'>void</span></span><span id='textcolor27'><span class='cmtt-10'> </span></span><span class='cmtt-10'>__arena</span><span id='textcolor28'><span class='cmtt-10'> </span></span><span id='textcolor29'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>addr,</span> 
<a id='x1-4008r2'></a><span id='textcolor30'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>__u32</span><span id='textcolor31'><span class='cmtt-10'> </span></span><span class='cmtt-10'>page_cnt,</span><span id='textcolor32'><span class='cmtt-10'> </span></span><span id='textcolor33'><span class='cmtt-10'>int</span></span><span id='textcolor34'><span class='cmtt-10'> </span></span><span class='cmtt-10'>node_id,</span><span id='textcolor35'><span class='cmtt-10'> </span></span><span class='cmtt-10'>__u64</span><span id='textcolor36'><span class='cmtt-10'> </span></span><span class='cmtt-10'>flags)</span><span id='textcolor37'><span class='cmtt-10'> </span></span><span class='cmtt-10'>__ksym;</span> 
<a id='x1-4010r3'></a><span id='textcolor38'><span class='cmtt-10'>void</span></span><span id='textcolor39'><span class='cmtt-10'> </span></span><span id='textcolor40'><span class='cmtt-10'>bpf_arena_free_pages</span></span><span class='cmtt-10'>(</span><span id='textcolor41'><span class='cmtt-10'>void</span></span><span id='textcolor42'><span class='cmtt-10'> </span></span><span id='textcolor43'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>map,</span><span id='textcolor44'><span class='cmtt-10'> </span></span><span id='textcolor45'><span class='cmtt-10'>void</span></span><span id='textcolor46'><span class='cmtt-10'> </span></span><span class='cmtt-10'>__arena</span><span id='textcolor47'><span class='cmtt-10'> </span></span><span id='textcolor48'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>ptr,</span> 
<a id='x1-4012r4'></a><span id='textcolor49'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>__u32</span><span id='textcolor50'><span class='cmtt-10'> </span></span><span class='cmtt-10'>page_cnt)</span><span id='textcolor51'><span class='cmtt-10'> </span></span><span class='cmtt-10'>__ksym;</span></pre>
<figcaption class='caption'><span class='id'>Listing 2:</span><span class='content'>Functions operating on Arena MAP.</span></figcaption><!-- tex4ht:label?: x1-4013r2  -->
                                                                  

                                                                  
</figure>
<!-- l. 126 --><p class='noindent'>Calling these functions may put the thread to sleep. For this reason the functions
are marked with <span class='cmtt-10'>KF_SLEEPABLE</span> <span class='cite'>[<a href='#Xarena_source'>4</a>]</span>, and the verifier only allows sleepable
eBPF programs to use them. An eBPF program has sleeping privilege if the
<span class='cmtt-10'>BPF_F_SLEEPABLE </span>flag was set when loading it (see Listing <a href='#-user-space-program-loading-the-program'>4<!-- tex4ht:ref: lst:loader  --></a> for an example). Not all
eBPF hooks support this flag. A list of sleepable hooks are provided in libbpf
documentations <span class='cite'>[<a href='#Xlibbpf_sleepable'>8</a>]</span>.
</p><!-- l. 135 --><p class='noindent'><span id='textcolor52'>note: The memory pages allocated use the following flags: <span class='cmitt-10'>GFP_KERNEL</span>, <span class='cmitt-10'>__GFP_ZERO</span>,
<span class='cmitt-10'>__GFP_ACCOUNT</span>.</span>
</p>
<h4 class='subsectionHead' id='managing-two-address-spaces'><span class='titlemark'>2.3   </span> <a id='x1-50002.3'></a>Managing two address spaces</h4>
<!-- l. 139 --><p class='noindent'>Clang compiler, the verifier, the JIT, and the runtime all work together to make sure
the eBPF program accesses the correct memory address. When using Arena, there is
a translation between the user address space and kernel address space (unless the
map is declared with “<span class='cmtt-10'>BPF_F_NO_USER_CONV</span>” flag present). The eBPF program must
mark the pointers with “<span class='cmtt-10'>__attribute__((address_space(1)))</span>” to let the Clang
know about it and cause the generation of “<span class='cmtt-10'>bpf_arena_cast_user/kern</span>”
instructions. The “<span class='cmtt-10'>__arena</span>” tag used in the examples (and the accompanying
repository), especially when declaring variables and parameters, serves this
purpose.
</p><!-- l. 152 --><p class='noindent'>
</p>
<h3 class='sectionHead' id='examples'><span class='titlemark'>3   </span> <a id='x1-60003'></a>Examples</h3>
<!-- l. 154 --><p class='noindent'>I try to demonstrate how these APIs can be used to implement the use-cases named
above.
</p><!-- l. 157 --><p class='noindent'>
</p>
<h4 class='subsectionHead' id='memory-shared-among-ebpf-and-userspace'><span class='titlemark'>3.1   </span> <a id='x1-70003.1'></a>Memory shared among eBPF and user-space</h4>
<!-- l. 159 --><p class='noindent'>As a first step, let us demonstrate how to share a counter between an eBPF and an
user-space program. For the sake of example, I used an eBPF program of type
<span class='cmtt-10'>BPF_PROT_TYPE_SYSCALL</span> <span class='cite'>[<a href='#Xebpf_docs_prog_syscall'>10</a>]</span> which does not need to be attached to a hook and
can simply be invoked using a system call (for more information search for
<span class='cmtt-10'>BPF_PROG_TEST_RUN</span> <span class='cite'>[<a href='#Xebpf_docs_bpf_prog_run'>9</a>]</span>).
</p><!-- l. 165 --><p class='noindent'>Listing <a href='#-an-ebpf-program-using-arena'>3<!-- tex4ht:ref: lst:mogu  --></a> shows the code for the example program. In this program, a global variable
(“<span class='cmtt-10'>flag_initialized</span>”) tracks whether it is the first time the program is executed or
not. In the first run, a page is allocated (using “<span class='cmtt-10'>bpf_arena_alloc_pages</span>”) and its
address is kept in “<span class='cmtt-10'>mem</span>” global variable. The allocated memory will hold a counter
keeping the number of invocations.
                                                                  

                                                                  
</p><!-- l. 173 --><p class='noindent'><span id='textcolor53'>note: The global variable support is available since kernel version 5.2 <span class='cite'>[<a href='#Xglb_var_post'>1</a>]</span>.</span>
                                                                  

                                                                  
</p><!-- l. 176 --><p class='noindent' id='-an-ebpf-program-using-arena'><a id='x1-7073r3'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb3'><a id='x1-7026r1'></a><span id='textcolor54'><span class='cmitt-10'>/* Declaration of Arena MAP as in Listing 1 ... */</span></span> 
<a id='x1-7028r2'></a><span id='textcolor55'><span class='cmtt-10'>static</span></span><span id='textcolor56'><span class='cmtt-10'> </span></span><span id='textcolor57'><span class='cmtt-10'>bool</span></span><span id='textcolor58'><span class='cmtt-10'> </span></span><span class='cmtt-10'>flag_initialized</span><span id='textcolor59'><span class='cmtt-10'> </span></span><span id='textcolor60'><span class='cmtt-10'>=</span></span><span id='textcolor61'><span class='cmtt-10'> </span></span><span id='textcolor62'><span class='cmtt-10'>false</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7030r3'></a><span class='cmtt-10'>__arena</span><span id='textcolor63'><span class='cmtt-10'> </span></span><span id='textcolor64'><span class='cmtt-10'>void</span></span><span id='textcolor65'><span class='cmtt-10'> </span></span><span id='textcolor66'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>mem</span><span id='textcolor67'><span class='cmtt-10'> </span></span><span id='textcolor68'><span class='cmtt-10'>=</span></span><span id='textcolor69'><span class='cmtt-10'> </span></span><span id='textcolor70'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7032r4'></a><span class='cmtt-10'>SEC(</span><span id='textcolor71'><span class='cmtt-10'>"syscall"</span></span><span class='cmtt-10'>)</span> 
<a id='x1-7034r5'></a><span id='textcolor72'><span class='cmtt-10'>int</span></span><span id='textcolor73'><span class='cmtt-10'> </span></span><span class='cmtt-10'>mogu(</span><span id='textcolor74'><span class='cmtt-10'>void</span></span><span id='textcolor75'><span class='cmtt-10'> </span></span><span id='textcolor76'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>_)</span> 
<a id='x1-7036r6'></a><span class='cmtt-10'>{</span> 
<a id='x1-7038r7'></a><span id='textcolor77'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>bpf_printk(</span><span id='textcolor78'><span class='cmtt-10'>"mogu: hello</span></span><span id='textcolor79'><span class='cmtt-10'>\n</span></span><span id='textcolor80'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7040r8'></a><span id='textcolor81'><span class='cmtt-10'>    </span></span><span id='textcolor82'><span class='cmtt-10'>if</span></span><span id='textcolor83'><span class='cmtt-10'> </span></span><span class='cmtt-10'>(</span><span id='textcolor84'><span class='cmtt-10'>!</span></span><span class='cmtt-10'>flag_initialized)</span><span id='textcolor85'><span class='cmtt-10'> </span></span><span class='cmtt-10'>{</span> 
<a id='x1-7042r9'></a><span id='textcolor86'><span class='cmtt-10'>        </span></span><span class='cmtt-10'>mem</span><span id='textcolor87'><span class='cmtt-10'> </span></span><span id='textcolor88'><span class='cmtt-10'>=</span></span><span id='textcolor89'><span class='cmtt-10'> </span></span><span class='cmtt-10'>bpf_arena_alloc_pages(</span><span id='textcolor90'><span class='cmtt-10'>&amp;</span></span><span class='cmtt-10'>arena,</span><span id='textcolor91'><span class='cmtt-10'> </span></span><span id='textcolor92'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>,</span><span id='textcolor93'><span class='cmtt-10'> </span></span><span id='textcolor94'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>,</span><span id='textcolor95'><span class='cmtt-10'> </span></span><span class='cmtt-10'>NUMA_NO_NODE,</span><span id='textcolor96'><span class='cmtt-10'> </span></span><span id='textcolor97'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7044r10'></a><span id='textcolor98'><span class='cmtt-10'>        </span></span><span id='textcolor99'><span class='cmtt-10'>if</span></span><span id='textcolor100'><span class='cmtt-10'> </span></span><span class='cmtt-10'>(mem</span><span id='textcolor101'><span class='cmtt-10'> </span></span><span id='textcolor102'><span class='cmtt-10'>==</span></span><span id='textcolor103'><span class='cmtt-10'> </span></span><span id='textcolor104'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>)</span><span id='textcolor105'><span class='cmtt-10'> </span></span><span class='cmtt-10'>{</span> 
<a id='x1-7046r11'></a><span id='textcolor106'><span class='cmtt-10'>            </span></span><span class='cmtt-10'>bpf_printk(</span><span id='textcolor107'><span class='cmtt-10'>"Failed to allocate memory"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7048r12'></a><span id='textcolor108'><span class='cmtt-10'>            </span></span><span id='textcolor109'><span class='cmtt-10'>return</span></span><span id='textcolor110'><span class='cmtt-10'> </span></span><span id='textcolor111'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7050r13'></a><span id='textcolor112'><span class='cmtt-10'>        </span></span><span class='cmtt-10'>}</span> 
<a id='x1-7052r14'></a><span id='textcolor113'><span class='cmtt-10'>        </span></span><span class='cmtt-10'>flag_initialized</span><span id='textcolor114'><span class='cmtt-10'> </span></span><span id='textcolor115'><span class='cmtt-10'>=</span></span><span id='textcolor116'><span class='cmtt-10'> </span></span><span id='textcolor117'><span class='cmtt-10'>true</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7054r15'></a><span id='textcolor118'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>}</span> 
<a id='x1-7056r16'></a><span id='textcolor119'><span class='cmtt-10'>    </span></span><span id='textcolor120'><span class='cmtt-10'>if</span></span><span id='textcolor121'><span class='cmtt-10'> </span></span><span class='cmtt-10'>(mem</span><span id='textcolor122'><span class='cmtt-10'> </span></span><span id='textcolor123'><span class='cmtt-10'>==</span></span><span id='textcolor124'><span class='cmtt-10'> </span></span><span id='textcolor125'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>)</span><span id='textcolor126'><span class='cmtt-10'> </span></span><span class='cmtt-10'>{</span> 
<a id='x1-7058r17'></a><span id='textcolor127'><span class='cmtt-10'>        </span></span><span id='textcolor128'><span class='cmitt-10'>/* this branch must never happen! */</span></span> 
<a id='x1-7060r18'></a><span id='textcolor129'><span class='cmtt-10'>        </span></span><span id='textcolor130'><span class='cmtt-10'>return</span></span><span id='textcolor131'><span class='cmtt-10'> </span></span><span id='textcolor132'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7062r19'></a><span id='textcolor133'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>}</span> 
<a id='x1-7064r20'></a><span id='textcolor134'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>__arena</span><span id='textcolor135'><span class='cmtt-10'> </span></span><span class='cmtt-10'>entry_t</span><span id='textcolor136'><span class='cmtt-10'> </span></span><span id='textcolor137'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>e</span><span id='textcolor138'><span class='cmtt-10'> </span></span><span id='textcolor139'><span class='cmtt-10'>=</span></span><span id='textcolor140'><span class='cmtt-10'> </span></span><span class='cmtt-10'>mem;</span> 
<a id='x1-7066r21'></a><span id='textcolor141'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>e</span><span id='textcolor142'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>counter</span><span id='textcolor143'><span class='cmtt-10'> </span></span><span id='textcolor144'><span class='cmtt-10'>+=</span></span><span id='textcolor145'><span class='cmtt-10'> </span></span><span id='textcolor146'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7068r22'></a><span id='textcolor147'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>bpf_printk(</span><span id='textcolor148'><span class='cmtt-10'>"counter: %lld</span></span><span id='textcolor149'><span class='cmtt-10'>\n</span></span><span id='textcolor150'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>,</span><span id='textcolor151'><span class='cmtt-10'> </span></span><span class='cmtt-10'>e</span><span id='textcolor152'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>counter);</span> 
<a id='x1-7070r23'></a><span id='textcolor153'><span class='cmtt-10'>    </span></span><span id='textcolor154'><span class='cmtt-10'>return</span></span><span id='textcolor155'><span class='cmtt-10'> </span></span><span id='textcolor156'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7072r24'></a><span class='cmtt-10'>}</span></pre>
<figcaption class='caption'><span class='id'>Listing 3:</span><span class='content'>An eBPF program using Arena.</span></figcaption><!-- tex4ht:label?: x1-7073r3  -->
                                                                  

                                                                  
</figure>
<!-- l. 206 --><p class='noindent'>Next, in Listing <a href='#-user-space-program-loading-the-program'>4<!-- tex4ht:ref: lst:loader  --></a>, we see how user-space program loads the eBPF program and
Listing <a href='#-userspace-accessing-the-memory-page-allocated-from-arena'>5<!-- tex4ht:ref: lst:loader_read  --></a> shows it accessing the counter on the Arena memory page (The user-space
relies on libbpf and its skeleton framework <span class='cite'>[<a href='#Xlibbpf_skeleton'>5</a>]</span>).
                                                                  

                                                                  
</p><!-- l. 212 --><p class='noindent' id='-user-space-program-loading-the-program'><a id='x1-7191r4'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb4'><a id='x1-7114r1'></a><span id='textcolor157'><span class='cmitt-10'>/* Some global vars */</span></span> 
<a id='x1-7116r2'></a><span id='textcolor158'><span class='cmtt-10'>static</span></span><span id='textcolor159'><span class='cmtt-10'> </span></span><span id='textcolor160'><span class='cmtt-10'>volatile</span></span><span id='textcolor161'><span class='cmtt-10'> </span></span><span id='textcolor162'><span class='cmtt-10'>int</span></span><span id='textcolor163'><span class='cmtt-10'> </span></span><span class='cmtt-10'>running</span><span id='textcolor164'><span class='cmtt-10'> </span></span><span id='textcolor165'><span class='cmtt-10'>=</span></span><span id='textcolor166'><span class='cmtt-10'> </span></span><span id='textcolor167'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7118r3'></a><span id='textcolor168'><span class='cmtt-10'>static</span></span><span id='textcolor169'><span class='cmtt-10'> </span></span><span id='textcolor170'><span class='cmtt-10'>int</span></span><span id='textcolor171'><span class='cmtt-10'> </span></span><span class='cmtt-10'>ebpf_prog_fd</span><span id='textcolor172'><span class='cmtt-10'> </span></span><span id='textcolor173'><span class='cmtt-10'>=</span></span><span id='textcolor174'><span class='cmtt-10'> </span></span><span id='textcolor175'><span class='cmtt-10'>-1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7120r4'></a><span id='textcolor176'><span class='cmtt-10'>static</span></span><span id='textcolor177'><span class='cmtt-10'> </span></span><span id='textcolor178'><span class='cmtt-10'>struct</span></span><span id='textcolor179'><span class='cmtt-10'> </span></span><span id='textcolor180'><span class='cmtt-10'>mogu</span></span><span id='textcolor181'><span class='cmtt-10'> </span></span><span id='textcolor182'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>skel</span><span id='textcolor183'><span class='cmtt-10'> </span></span><span id='textcolor184'><span class='cmtt-10'>=</span></span><span id='textcolor185'><span class='cmtt-10'> </span></span><span id='textcolor186'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7122r5'></a> 
<a id='x1-7124r6'></a><span id='textcolor187'><span class='cmtt-10'>int</span></span><span id='textcolor188'><span class='cmtt-10'> </span></span><span id='textcolor189'><span class='cmtt-10'>main</span></span><span class='cmtt-10'>(</span><span id='textcolor190'><span class='cmtt-10'>int</span></span><span id='textcolor191'><span class='cmtt-10'> </span></span><span class='cmtt-10'>argc,</span><span id='textcolor192'><span class='cmtt-10'> </span></span><span id='textcolor193'><span class='cmtt-10'>char</span></span><span id='textcolor194'><span class='cmtt-10'> </span></span><span id='textcolor195'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>argv[])</span> 
<a id='x1-7126r7'></a><span class='cmtt-10'>{</span> 
<a id='x1-7128r8'></a><span class='cmtt-10'>skel</span><span id='textcolor196'><span class='cmtt-10'> </span></span><span id='textcolor197'><span class='cmtt-10'>=</span></span><span id='textcolor198'><span class='cmtt-10'> </span></span><span class='cmtt-10'>mogu__open();</span> 
<a id='x1-7130r9'></a><span id='textcolor199'><span class='cmtt-10'>if</span></span><span id='textcolor200'><span class='cmtt-10'> </span></span><span class='cmtt-10'>(</span><span id='textcolor201'><span class='cmtt-10'>!</span></span><span class='cmtt-10'>skel)</span><span id='textcolor202'><span class='cmtt-10'> </span></span><span class='cmtt-10'>{</span> 
<a id='x1-7132r10'></a><span id='textcolor203'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>fprintf(stderr,</span><span id='textcolor204'><span class='cmtt-10'> </span></span><span id='textcolor205'><span class='cmtt-10'>"Failed to open the skeleton</span></span><span id='textcolor206'><span class='cmtt-10'>\n</span></span><span id='textcolor207'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7134r11'></a><span id='textcolor208'><span class='cmtt-10'>    </span></span><span id='textcolor209'><span class='cmtt-10'>return</span></span><span id='textcolor210'><span class='cmtt-10'> </span></span><span class='cmtt-10'>EXIT_FAILURE;</span> 
<a id='x1-7136r12'></a><span class='cmtt-10'>}</span> 
<a id='x1-7138r13'></a><span id='textcolor211'><span class='cmitt-10'>/* Set sleepable flag */</span></span> 
<a id='x1-7140r14'></a><span class='cmtt-10'>bpf_program__set_flags(skel</span><span id='textcolor212'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>progs.mogu,</span><span id='textcolor213'><span class='cmtt-10'> </span></span><span class='cmtt-10'>BPF_F_SLEEPABLE);</span> 
<a id='x1-7142r15'></a><span id='textcolor214'><span class='cmtt-10'>if</span></span><span id='textcolor215'><span class='cmtt-10'> </span></span><span class='cmtt-10'>(mogu__load(skel))</span><span id='textcolor216'><span class='cmtt-10'> </span></span><span class='cmtt-10'>{</span> 
<a id='x1-7144r16'></a><span id='textcolor217'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>fprintf(stderr,</span><span id='textcolor218'><span class='cmtt-10'> </span></span><span id='textcolor219'><span class='cmtt-10'>"Failed to load eBPF program</span></span><span id='textcolor220'><span class='cmtt-10'>\n</span></span><span id='textcolor221'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7146r17'></a><span id='textcolor222'><span class='cmtt-10'>    </span></span><span id='textcolor223'><span class='cmtt-10'>return</span></span><span id='textcolor224'><span class='cmtt-10'> </span></span><span class='cmtt-10'>EXIT_FAILURE;</span> 
<a id='x1-7148r18'></a><span class='cmtt-10'>}</span> 
<a id='x1-7150r19'></a> 
<a id='x1-7152r20'></a><span class='cmtt-10'>ebpf_prog_fd</span><span id='textcolor225'><span class='cmtt-10'> </span></span><span id='textcolor226'><span class='cmtt-10'>=</span></span><span id='textcolor227'><span class='cmtt-10'> </span></span><span class='cmtt-10'>bpf_program__fd(skel</span><span id='textcolor228'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>progs.mogu);</span> 
<a id='x1-7154r21'></a><span id='textcolor229'><span class='cmitt-10'>/* It will invoke the eBPF program for the first time */</span></span> 
<a id='x1-7156r22'></a><span class='cmtt-10'>handle_invoke_signal(</span><span id='textcolor230'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7158r23'></a> 
<a id='x1-7160r24'></a><span id='textcolor231'><span class='cmitt-10'>/* Keep running and handle signals */</span></span> 
<a id='x1-7162r25'></a><span class='cmtt-10'>running</span><span id='textcolor232'><span class='cmtt-10'> </span></span><span id='textcolor233'><span class='cmtt-10'>=</span></span><span id='textcolor234'><span class='cmtt-10'> </span></span><span id='textcolor235'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7164r26'></a><span class='cmtt-10'>signal(SIGINT,</span><span id='textcolor236'><span class='cmtt-10'> </span></span><span class='cmtt-10'>handle_signal);</span> 
<a id='x1-7166r27'></a><span class='cmtt-10'>signal(SIGHUP,</span><span id='textcolor237'><span class='cmtt-10'> </span></span><span class='cmtt-10'>handle_signal);</span> 
<a id='x1-7168r28'></a><span class='cmtt-10'>signal(SIGUSR1,</span><span id='textcolor238'><span class='cmtt-10'> </span></span><span class='cmtt-10'>handle_invoke_signal);</span> 
<a id='x1-7170r29'></a><span class='cmtt-10'>printf(</span><span id='textcolor239'><span class='cmtt-10'>"Hit Ctrl+C to terminate ...</span></span><span id='textcolor240'><span class='cmtt-10'>\n</span></span><span id='textcolor241'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7172r30'></a><span class='cmtt-10'>printf(</span><span id='textcolor242'><span class='cmtt-10'>"Invoke eBPF program:</span></span><span id='textcolor243'><span class='cmtt-10'>\n</span></span><span id='textcolor244'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7174r31'></a><span class='cmtt-10'>printf(</span><span id='textcolor245'><span class='cmtt-10'>"</span></span><span id='textcolor246'><span class='cmtt-10'>\t</span></span><span id='textcolor247'><span class='cmtt-10'>Mogu: pkill -SIGUSR1 mogu_loader</span></span><span id='textcolor248'><span class='cmtt-10'>\n</span></span><span id='textcolor249'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7176r32'></a> 
<a id='x1-7178r33'></a><span id='textcolor250'><span class='cmtt-10'>while</span></span><span id='textcolor251'><span class='cmtt-10'> </span></span><span class='cmtt-10'>(running)</span><span id='textcolor252'><span class='cmtt-10'> </span></span><span class='cmtt-10'>{</span><span id='textcolor253'><span class='cmtt-10'> </span></span><span class='cmtt-10'>pause();</span><span id='textcolor254'><span class='cmtt-10'> </span></span><span class='cmtt-10'>}</span> 
<a id='x1-7180r34'></a> 
<a id='x1-7182r35'></a><span class='cmtt-10'>mogu__detach(skel);</span> 
<a id='x1-7184r36'></a><span class='cmtt-10'>mogu__destroy(skel);</span> 
<a id='x1-7186r37'></a><span class='cmtt-10'>printf(</span><span id='textcolor255'><span class='cmtt-10'>"Done!</span></span><span id='textcolor256'><span class='cmtt-10'>\n</span></span><span id='textcolor257'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7188r38'></a><span id='textcolor258'><span class='cmtt-10'>return</span></span><span id='textcolor259'><span class='cmtt-10'> </span></span><span id='textcolor260'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7190r39'></a><span class='cmtt-10'>}</span></pre>
<figcaption class='caption'><span class='id'>Listing 4:</span><span class='content'>User space program loading the program</span></figcaption><!-- tex4ht:label?: x1-7191r4  -->
                                                                  

                                                                  
</figure>
                                                                  

                                                                  
<!-- l. 258 --><p class='noindent' id='-userspace-accessing-the-memory-page-allocated-from-arena'><a id='x1-7210r5'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb5'><a id='x1-7199r1'></a><span class='cmtt-10'>entry_t</span><span id='textcolor261'><span class='cmtt-10'> </span></span><span id='textcolor262'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>e</span><span id='textcolor263'><span class='cmtt-10'> </span></span><span id='textcolor264'><span class='cmtt-10'>=</span></span><span id='textcolor265'><span class='cmtt-10'> </span></span><span class='cmtt-10'>skel</span><span id='textcolor266'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>bss</span><span id='textcolor267'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>mem;</span> 
<a id='x1-7201r2'></a><span id='textcolor268'><span class='cmtt-10'>if</span></span><span id='textcolor269'><span class='cmtt-10'> </span></span><span class='cmtt-10'>(e</span><span id='textcolor270'><span class='cmtt-10'> </span></span><span id='textcolor271'><span class='cmtt-10'>==</span></span><span id='textcolor272'><span class='cmtt-10'> </span></span><span id='textcolor273'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>)</span><span id='textcolor274'><span class='cmtt-10'> </span></span><span class='cmtt-10'>{</span> 
<a id='x1-7203r3'></a><span id='textcolor275'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>printf(</span><span id='textcolor276'><span class='cmtt-10'>"NOTE: the initialization was not successful!</span></span><span id='textcolor277'><span class='cmtt-10'>\n</span></span><span id='textcolor278'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7205r4'></a><span id='textcolor279'><span class='cmtt-10'>    </span></span><span id='textcolor280'><span class='cmtt-10'>return</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7207r5'></a><span class='cmtt-10'>}</span> 
<a id='x1-7209r6'></a><span class='cmtt-10'>printf(</span><span id='textcolor281'><span class='cmtt-10'>"user: counter=%lld</span></span><span id='textcolor282'><span class='cmtt-10'>\n</span></span><span id='textcolor283'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>,</span><span id='textcolor284'><span class='cmtt-10'> </span></span><span class='cmtt-10'>e</span><span id='textcolor285'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>counter);</span></pre>
<figcaption class='caption'><span class='id'>Listing 5:</span><span class='content'>User-space accessing the memory page allocated from Arena</span></figcaption><!-- tex4ht:label?: x1-7210r5  -->
                                                                  

                                                                  
</figure>
<h4 class='subsectionHead' id='using-arena-in-xdp-or-other-hooks-that-can-not-sleep'><span class='titlemark'>3.2   </span> <a id='x1-80003.2'></a>Using Arena in XDP (or other hooks that can not sleep)</h4>
<!-- l. 273 --><p class='noindent'>As was mentioned, Arena memory allocation helper functions may put the calling
thread to sleep. This is not acceptable for programs attached to hooks such as XDP.
But, this limitation does not mean that XDP programs can not access the arena
memory. They just can not allocate or free the pages.
</p><!-- l. 278 --><p class='noindent'>For the next step, Let us share the memory page allocated by the program from the
previous example with another eBPF program. This allows the second program to
use Arena backed memory pages without allocating memory itself. Listing <a href='#-an-ebpf-program-that-uses-arena-pages-allocated-from-another-program'>6<!-- tex4ht:ref: lst:aloe  --></a> shows
the second eBPF program.
</p><!-- l. 283 --><p class='noindent'>Here are some details that I like to bring to your attention:
     </p><ol class='enumerate1'>
<li class='enumerate' id='x1-8002x1'>Notice that both eBPF programs declare an Arena (as shown in Listing <a href='#-example-of-using-arena-map'>1<!-- tex4ht:ref: lst:map_ex  --></a>).
     The loader (will be discussed next) will make sure both are using the same
     MAP using the libbpf’s <span class='cmtt-10'>bpf_map__reuse_fd </span>helper.
     </li>
<li class='enumerate' id='x1-8004x2'>The second program expects the loader to pass the address of allocated
     page through its global variable called “mem”. This address could have
     been shared among the two program in other ways, e.g. through a shared
     array MAP.
     </li>
<li class='enumerate' id='x1-8006x3'>The   second   program   is   using   a   non-standard   helper   named
     “<span class='cmtt-10'>my_kfunc_reg_arena</span>”. This function (a kfunc defined by me) does not
     perform any operation. Its sole role is to let the verifier recognize that the
     program is using the Arena. See <span class='tcrm-1000'>§</span><a href='#why-do-we-need-a-custom-arena-function'>3.2.1<!-- tex4ht:ref: sec:need_custom  --></a> for more detail.</li></ol>
                                                                  

                                                                  
<!-- l. 301 --><p class='noindent' id='-an-ebpf-program-that-uses-arena-pages-allocated-from-another-program'><a id='x1-8064r6'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb6'><a id='x1-8027r1'></a><span id='textcolor286'><span class='cmitt-10'>/* Declaration of Arena MAP as in Listing 1 ... */</span></span> 
<a id='x1-8029r2'></a><span class='cmtt-10'>__arena</span><span id='textcolor287'><span class='cmtt-10'> </span></span><span id='textcolor288'><span class='cmtt-10'>void</span></span><span id='textcolor289'><span class='cmtt-10'> </span></span><span id='textcolor290'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>mem</span><span id='textcolor291'><span class='cmtt-10'> </span></span><span id='textcolor292'><span class='cmtt-10'>=</span></span><span id='textcolor293'><span class='cmtt-10'> </span></span><span id='textcolor294'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>;</span> 
<a id='x1-8031r3'></a> 
<a id='x1-8033r4'></a><span id='textcolor295'><span class='cmitt-10'>/* Load the kernel module for adding this kfunc */</span></span> 
<a id='x1-8035r5'></a><span id='textcolor296'><span class='cmtt-10'>long</span></span><span id='textcolor297'><span class='cmtt-10'> </span></span><span id='textcolor298'><span class='cmtt-10'>my_kfunc_reg_arena</span></span><span class='cmtt-10'>(</span><span id='textcolor299'><span class='cmtt-10'>void</span></span><span id='textcolor300'><span class='cmtt-10'> </span></span><span id='textcolor301'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>p__map)</span><span id='textcolor302'><span class='cmtt-10'> </span></span><span class='cmtt-10'>__ksym;</span> 
<a id='x1-8037r6'></a> 
<a id='x1-8039r7'></a><span class='cmtt-10'>SEC(</span><span id='textcolor303'><span class='cmtt-10'>"syscall"</span></span><span class='cmtt-10'>)</span> 
<a id='x1-8041r8'></a><span id='textcolor304'><span class='cmtt-10'>int</span></span><span id='textcolor305'><span class='cmtt-10'> </span></span><span class='cmtt-10'>aloe_main(</span><span id='textcolor306'><span class='cmtt-10'>void</span></span><span id='textcolor307'><span class='cmtt-10'> </span></span><span id='textcolor308'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>_)</span> 
<a id='x1-8043r9'></a><span class='cmtt-10'>{</span> 
<a id='x1-8045r10'></a><span id='textcolor309'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>my_kfunc_reg_arena(</span><span id='textcolor310'><span class='cmtt-10'>&amp;</span></span><span class='cmtt-10'>arena_map);</span> 
<a id='x1-8047r11'></a><span id='textcolor311'><span class='cmtt-10'>    </span></span><span id='textcolor312'><span class='cmtt-10'>if</span></span><span id='textcolor313'><span class='cmtt-10'> </span></span><span class='cmtt-10'>(mem</span><span id='textcolor314'><span class='cmtt-10'> </span></span><span id='textcolor315'><span class='cmtt-10'>==</span></span><span id='textcolor316'><span class='cmtt-10'> </span></span><span id='textcolor317'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>)</span><span id='textcolor318'><span class='cmtt-10'> </span></span><span class='cmtt-10'>{</span> 
<a id='x1-8049r12'></a><span id='textcolor319'><span class='cmtt-10'>        </span></span><span class='cmtt-10'>bpf_printk(</span><span id='textcolor320'><span class='cmtt-10'>"aloe: not seeing the memory!</span></span><span id='textcolor321'><span class='cmtt-10'>\n</span></span><span id='textcolor322'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-8051r13'></a><span id='textcolor323'><span class='cmtt-10'>        </span></span><span id='textcolor324'><span class='cmtt-10'>return</span></span><span id='textcolor325'><span class='cmtt-10'> </span></span><span id='textcolor326'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-8053r14'></a><span id='textcolor327'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>}</span> 
<a id='x1-8055r15'></a><span id='textcolor328'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>__arena</span><span id='textcolor329'><span class='cmtt-10'> </span></span><span class='cmtt-10'>entry_t</span><span id='textcolor330'><span class='cmtt-10'> </span></span><span id='textcolor331'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>e</span><span id='textcolor332'><span class='cmtt-10'> </span></span><span id='textcolor333'><span class='cmtt-10'>=</span></span><span id='textcolor334'><span class='cmtt-10'> </span></span><span class='cmtt-10'>mem;</span> 
<a id='x1-8057r16'></a><span id='textcolor335'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>bpf_printk(</span><span id='textcolor336'><span class='cmtt-10'>"aloe: counter=%lld</span></span><span id='textcolor337'><span class='cmtt-10'>\n</span></span><span id='textcolor338'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>,</span><span id='textcolor339'><span class='cmtt-10'> </span></span><span class='cmtt-10'>e</span><span id='textcolor340'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>counter);</span> 
<a id='x1-8059r17'></a><span id='textcolor341'><span class='cmtt-10'>    </span></span><span class='cmtt-10'>e</span><span id='textcolor342'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>counter</span><span id='textcolor343'><span class='cmtt-10'> </span></span><span id='textcolor344'><span class='cmtt-10'>+=</span></span><span id='textcolor345'><span class='cmtt-10'> </span></span><span id='textcolor346'><span class='cmtt-10'>100</span></span><span class='cmtt-10'>;</span> 
<a id='x1-8061r18'></a><span id='textcolor347'><span class='cmtt-10'>    </span></span><span id='textcolor348'><span class='cmtt-10'>return</span></span><span id='textcolor349'><span class='cmtt-10'> </span></span><span id='textcolor350'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>;</span> 
<a id='x1-8063r19'></a><span class='cmtt-10'>}</span></pre>
<figcaption class='caption'><span class='id'>Listing  6:</span><span class='content'>An  eBPF  program  that  uses  Arena  pages  allocated  from  another
program</span></figcaption><!-- tex4ht:label?: x1-8064r6  -->
                                                                  

                                                                  
</figure>
<!-- l. 326 --><p class='noindent'>To share the Arena from the first eBPF program (Listing <a href='#-an-ebpf-program-using-arena'>3<!-- tex4ht:ref: lst:mogu  --></a>) with the second one
(Listing <a href='#-an-ebpf-program-that-uses-arena-pages-allocated-from-another-program'>6<!-- tex4ht:ref: lst:aloe  --></a>), the loader (user-space) program has to mediate and pass the
reference from first program to the second. Listing <a href='#-loader-program-assigning-the-arena-from-the-first-program-to-the-second-program'>7<!-- tex4ht:ref: lst:share-map-ref  --></a> shows an example of this
procedure.
                                                                  

                                                                  
</p><!-- l. 332 --><p class='noindent' id='-loader-program-assigning-the-arena-from-the-first-program-to-the-second-program'><a id='x1-8077r7'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb7'><a id='x1-8070r1'></a><span id='textcolor351'><span class='cmtt-10'>int</span></span><span id='textcolor352'><span class='cmtt-10'> </span></span><span class='cmtt-10'>arena_fd</span><span id='textcolor353'><span class='cmtt-10'> </span></span><span id='textcolor354'><span class='cmtt-10'>=</span></span><span id='textcolor355'><span class='cmtt-10'> </span></span><span class='cmtt-10'>bpf_map__fd(skel1</span><span id='textcolor356'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>maps.arena);</span> 
<a id='x1-8072r2'></a><span class='cmtt-10'>bpf_map__reuse_fd(skel2</span><span id='textcolor357'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>maps.arena_map,</span><span id='textcolor358'><span class='cmtt-10'> </span></span><span class='cmtt-10'>arena_fd);</span> 
<a id='x1-8074r3'></a><span id='textcolor359'><span class='cmitt-10'>/* Pass the pointer to the  second program */</span></span> 
<a id='x1-8076r4'></a><span class='cmtt-10'>skel2</span><span id='textcolor360'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>bss</span><span id='textcolor361'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>mem</span><span id='textcolor362'><span class='cmtt-10'> </span></span><span id='textcolor363'><span class='cmtt-10'>=</span></span><span id='textcolor364'><span class='cmtt-10'> </span></span><span class='cmtt-10'>skel1</span><span id='textcolor365'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>bss</span><span id='textcolor366'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>mem;</span></pre>
<figcaption class='caption'><span class='id'>Listing 7:</span><span class='content'>Loader program assigning the Arena from the first program to the
second program</span></figcaption><!-- tex4ht:label?: x1-8077r7  -->
                                                                  

                                                                  
</figure>
<h5 class='subsubsectionHead' id='why-do-we-need-a-custom-arena-function'><span class='titlemark'>3.2.1   </span> <a id='x1-90003.2.1'></a>Why do we need a custom Arena function?</h5>
<!-- l. 344 --><p class='noindent'>If we remove the call to the non-standard <span class='cmtt-10'>my_kfunc_reg_arena </span>in Listing <a href='#-an-ebpf-program-that-uses-arena-pages-allocated-from-another-program'>6<!-- tex4ht:ref: lst:aloe  --></a>,
although the program would compile, the verifier will complain that the program
does not have any associated Arena map, but is trying to use Arena memory
addressing. The error message from verifier is as follows:
                                                                  

                                                                  
</p><!-- l. 350 --><p class='noindent' id='-verifier-error-message-when-the-arena-is-not-referenced-in-the-program'><a id='x1-9004r8'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb8'><a id='x1-9003r1'></a><span class='cmtt-10'>addr_space_cast</span><span id='textcolor367'><span class='cmtt-10'> </span></span><span class='cmtt-10'>insn</span><span id='textcolor368'><span class='cmtt-10'> </span></span><span class='cmtt-10'>can</span><span id='textcolor369'><span class='cmtt-10'> </span></span><span class='cmtt-10'>only</span><span id='textcolor370'><span class='cmtt-10'> </span></span><span class='cmtt-10'>be</span><span id='textcolor371'><span class='cmtt-10'> </span></span><span class='cmtt-10'>used</span><span id='textcolor372'><span class='cmtt-10'> </span></span><span class='cmtt-10'>in</span><span id='textcolor373'><span class='cmtt-10'> </span></span><span class='cmtt-10'>a</span><span id='textcolor374'><span class='cmtt-10'> </span></span><span class='cmtt-10'>program</span><span id='textcolor375'><span class='cmtt-10'> </span></span><span class='cmtt-10'>that</span><span id='textcolor376'><span class='cmtt-10'> </span></span><span class='cmtt-10'>has</span><span id='textcolor377'><span class='cmtt-10'> </span></span><span class='cmtt-10'>an</span><span id='textcolor378'><span class='cmtt-10'> </span></span><span class='cmtt-10'>associated</span><span id='textcolor379'><span class='cmtt-10'> </span></span><span class='cmtt-10'>arena</span></pre>
<figcaption class='caption'><span class='id'>Listing 8:</span><span class='content'>Verifier error message when the Arena is not referenced in the program</span></figcaption><!-- tex4ht:label?: x1-9004r8  -->
                                                                  

                                                                  
</figure>
<!-- l. 357 --><p class='noindent'>Looking at the verifiers source code to decipher the error message, we see that the
error is raised when the program is not associated with an Arena while the program
has an address space cast instruction <span class='cite'>[<a href='#Xverifier_arena_not_set'>6</a>]</span> (exactly as written in the error
message).
</p><!-- l. 362 --><p class='noindent'>The association of an Arena MAP to a program happens when the it is referenced
(e.g., by using a helper function). Unfortunately, in the second program we
deliberately do not want to use Arena specific helpers. Other helper functions such
as <span class='cmtt-10'>bpf_map_lookup_elem </span>also cause other complains from the verifier (in
my test it complained due to attempting a zero byte read). Defining a new
helper that does nothing but still satisfies the verifier is a smart hack around
the situation. It show cases the flexibility that kfunc has brought to eBPF
ecosystem.
</p><!-- l. 372 --><p class='noindent'><span id='textcolor380'>note: The idea of having a dummy helper was suggested by my lab-mate <a href='https://github.com/marcomole00/' target='_blank'>Marco
Mole</a>.</span>
</p>
<h4 class='subsectionHead' id='userspace-managed-datastructures'><span class='titlemark'>3.3   </span> <a id='x1-100003.3'></a>User-space managed data-structures</h4>
<!-- l. 377 --><p class='noindent'>In the third example, I demonstrate how user-space program can allocate pages of
Arena map (useful to implement its own custom data-structure). Since these
data-structures are on Arena pages, they will be accessible to eBPF programs sharing
the same Arena.
</p><!-- l. 382 --><p class='noindent'>We can use libbpf to get access to the Arena memory. The library has an API named
<span class='cmtt-10'>bpf_map__initial_value </span>(not well documented at the moment). As input, this
function receive a pointer to a MAP and a pointer to a 64-bit variable. The return
value is the address for the beginning of Arena memory region (mapped to the
user-space program memory address), also the 64-bit variable will be set to the size of
the currently allocated memory <span class='cite'>[<a href='#Xlibbpf_initial_value'>7</a>]</span>.
</p><!-- l. 390 --><p class='noindent'>To allocate memory pages, the user-space can cause page-faults by accessing memory
addresses in Arena. The page fault will notify the kernel to allocate the memory
page. For example, in our previous examples the Arena has two pages (see Listing <a href='#-example-of-using-arena-map'>1<!-- tex4ht:ref: lst:map_ex  --></a>).
Assuming size of each page is 4 KB, the program can access the Arena memory (the
address we found using <span class='cmtt-10'>bpf_map__initial_value</span>) at offset 0 and 4096 to allocate
the two pages. Accessing the memory outside of the Arena region will cause a
<span class='cmtt-10'>SIGSEGV </span>(Address boundary error).
</p><!-- l. 399 --><p class='noindent'>The user-space program can use these memory pages to implement its own
data-structures in the Arena which is will be visible to eBPF programs.
</p><!-- l. 403 --><p class='noindent'>
</p>
<h3 class='sectionHead' id='final-notes'><span class='titlemark'>4   </span> <a id='x1-110004'></a>Final Notes</h3>
<!-- l. 405 --><p class='noindent'>The Arena feature is very new. It will probably change and improve. I am sure by the
                                                                  

                                                                  
time it is mature, eBPF community has written good documentation and tutorials on
it but meanwhile I hope this post fill the gap. It is important for me to say
that although I tried my best to share correct information, I can not claim
that I understand every aspect of Arena’s implementation. There may be
misunderstandings on my side. In such a case please let me know and accept my
apology.
</p><!-- l. 413 --><p class='noindent'>I want to conclude by listing some of the limitations of Arena that I observed looking
at the verifier and x86 JIT code.
</p><!-- l. 416 --><p class='noindent'>
     </p><ol class='enumerate1'>
<li class='enumerate' id='x1-11002x1'>The atomic reads/writes are not supported in Arena memory region.
     </li>
<li class='enumerate' id='x1-11004x2'>Arena pointer arithmetics are converted to 32 bit operations.
     </li>
<li class='enumerate' id='x1-11006x3'>There can be only one Arena map per program of maximum size of 4 GB.
     </li>
<li class='enumerate' id='x1-11008x4'>Program must be JIT compiled (it is almost always the case)
     </li>
<li class='enumerate' id='x1-11010x5'><span class='cmtt-10'>BPF_CAP </span>and <span class='cmtt-10'>CAP_PERFMON </span>is needed for loading a program with Arena
     </li>
<li class='enumerate' id='x1-11012x6'>Sign extending load instruction is not supported for Arena memory region
     </li>
<li class='enumerate' id='x1-11014x7'>The cast to address-space(1) will generate a “<span class='cmtt-10'>dst = (u32)src</span>”
                                                                  

                                                                  
     </li>
<li class='enumerate' id='x1-11016x8'>The cast lets the verifier know that the pointer is to arena the cast to
     address-space (0) turns the value into a scalar.
     </li>
<li class='enumerate' id='x1-11018x9'>x86 JIT uses the R12 register to track the start of Arena virtual address
     (it was unused before).</li></ol>
<!-- l. 1 --><p class='noindent'>
</p>
<h3 class='likesectionHead' id='references'><a id='x1-120004'></a>References</h3>
<!-- l. 1 --><p class='noindent'>
    </p><div class='thebibliography'>
    <p class='bibitem'><span class='biblabel'>
  [1]<span class='bibsp'>   </span></span><a id='Xglb_var_post'></a>Johannes     Bechberger.            Hello     ebpf:     Global     variables.
    <a class='url' href='https://mostlynerdless.de/blog/2024/05/21/hello-ebpf-global-variables-10/'><span class='cmtt-10'>https://mostlynerdless.de/blog/2024/05/21/hello-ebpf-global-variables-10/</span></a>,
    2024.
    </p>
    <p class='bibitem'><span class='biblabel'>
  [2]<span class='bibsp'>   </span></span><a id='Xebpf_docs_kfunc'></a>Silvano Cirujano Cuesta and Dylan Reimerink.  ebpf documentations:
    kfuncs.     <a class='url' href='https://docs.ebpf.io/linux/concepts/kfuncs/'><span class='cmtt-10'>https://docs.ebpf.io/linux/concepts/kfuncs/</span></a>, 2024.
    </p>
    <p class='bibitem'><span class='biblabel'>
  [3]<span class='bibsp'>   </span></span><a id='Xeunomia_kfunc'></a>Extending ebpf beyond its limits: Custom kfuncs in kernel modules.
    <a class='url' href='https://eunomia.dev/tutorials/43-kfuncs/'><span class='cmtt-10'>https://eunomia.dev/tutorials/43-kfuncs/</span></a>, 2024.
    </p>
    <p class='bibitem'><span class='biblabel'>
  [4]<span class='bibsp'>   </span></span><a id='Xarena_source'></a>Linux       source       tree:       Arena       map       implementation.
    <a class='url' href='https://elixir.bootlin.com/linux/v6.13.1/source/kernel/bpf/arena.c'><span class='cmtt-10'>https://elixir.bootlin.com/linux/v6.13.1/source/kernel/bpf/arena.c</span></a>.
    </p>
    <p class='bibitem'><span class='biblabel'>
  [5]<span class='bibsp'>   </span></span><a id='Xlibbpf_skeleton'></a>Kernel  documentations:  Libbpf  overview:  Bpf  object  skeleton  file.
    <a class='url' href='https://docs.kernel.org/bpf/libbpf/libbpf_overview.html#bpf-object-skeleton-file'><span class='cmtt-10'>https://docs.kernel.org/bpf/libbpf/libbpf_overview.html#bpf-object-skeleton-file</span></a>,
    2024.
                                                                  

                                                                  
    </p>
    <p class='bibitem'><span class='biblabel'>
  [6]<span class='bibsp'>   </span></span><a id='Xverifier_arena_not_set'></a>Linux   source   tree:   ebpf   verifier:   Checking   for   arena   map.
    <a class='url' href='https://elixir.bootlin.com/linux/v6.13.2/source/kernel/bpf/verifier.c#L14569'><span class='cmtt-10'>https://elixir.bootlin.com/linux/v6.13.2/source/kernel/bpf/verifier.c#L14569</span></a>.
    </p>
    <p class='bibitem'><span class='biblabel'>
  [7]<span class='bibsp'>   </span></span><a id='Xlibbpf_initial_value'></a>Libbpf                      source:                      bpf_map__initial_value.
    <a class='url' href='https://github.com/libbpf/libbpf/blob/444f3c0e7a0fbfeeac4b3809a184c6640ce10306/src/libbpf.c#L10365'><span class='cmtt-10'>https://github.com/libbpf/libbpf/blob/444f3c0e7a0fbfeeac4b3809a184c6640ce10306/src/libbpf.c#L10365</span></a>,
    2024.
    </p>
    <p class='bibitem'><span class='biblabel'>
  [8]<span class='bibsp'>   </span></span><a id='Xlibbpf_sleepable'></a>Andrii    Nakryiko,    Donald    Hunter,    and    Daan    De Meyer.
    libbpf     documentation:     Program     types     and     elf     sections.
    <a class='url' href='https://github.com/libbpf/libbpf/blob/master/docs/program_types.rst'><span class='cmtt-10'>https://github.com/libbpf/libbpf/blob/master/docs/program_types.rst</span></a>.
    </p>
    <p class='bibitem'><span class='biblabel'>
  [9]<span class='bibsp'>   </span></span><a id='Xebpf_docs_bpf_prog_run'></a>Dylan Reimerink. ebpf documentations: Bpf syscall bpf_prog_test_run
    command.
    <a class='url' href='https://docs.ebpf.io/linux/syscall/BPF_PROG_TEST_RUN/'><span class='cmtt-10'>https://docs.ebpf.io/linux/syscall/BPF_PROG_TEST_RUN/</span></a>, 2023.
    </p>
    <p class='bibitem'><span class='biblabel'>
 [10]<span class='bibsp'>   </span></span><a id='Xebpf_docs_prog_syscall'></a>Dylan  Reimerink.      ebpf  documentations:  Bpf_prog_type_syscall.
    <a class='url' href='https://docs.ebpf.io/linux/program-type/BPF_PROG_TYPE_SYSCALL/'><span class='cmtt-10'>https://docs.ebpf.io/linux/program-type/BPF_PROG_TYPE_SYSCALL/</span></a>,
    2023.
    </p>
    <p class='bibitem'><span class='biblabel'>
 [11]<span class='bibsp'>   </span></span><a id='Xarenapatch'></a>Alex        Starovoitov.                      Introduce        bpf        arena.
    <a class='url' href='https://lwn.net/Articles/961594/'><span class='cmtt-10'>https://lwn.net/Articles/961594/</span></a>, 2024.
</p>
    </div>
 
</body> 
</html>