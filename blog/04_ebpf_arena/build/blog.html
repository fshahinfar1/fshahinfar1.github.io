<!DOCTYPE html> 
<html lang='en-US' xml:lang='en-US'> 
<head><title>eBPF Arena: A Tutorial</title> 
<meta charset='utf-8' /> 
<meta content='TeX4ht (https://tug.org/tex4ht/)' name='generator' /> 
<meta content='width=device-width,initial-scale=1' name='viewport' /> 
<link href='blog.css' rel='stylesheet' type='text/css' /> 
<meta content='blog.tex' name='src' /> 
</head><body>
   <div class='maketitle'>
                                                                  

                                                                  
                                                                  

                                                                  

<h2 class='titleHead'>eBPF Arena: A Tutorial</h2>
 <div class='author'><span class='cmr-12'>Farbod Shahinfar</span></div><br />
<div class='date'><span class='cmr-12'>July 5, 2025</span></div>
   </div> <p><span style='color:#808080;'><span class='cmr-9'>Estimated reading time: 10 minutes</span></span>
                                                                  

                                                                  

                                                                  

                                                                  
                                                                  

                                                                  
<!-- l. 19 --></p><p class='indent'>   As part of my research, I spend time learning about eBPF. Recently, I have been
busy exploring <span class='cmti-10'>Arena </span>— a new eBPF API that enables programs to allocate memory
pages; similar functionality as <span class='cmtt-10'>mmap </span>and <span class='cmtt-10'>munmap</span> <span class='cite'>[<a href='#Xarenapatch'>13</a>]</span>.
</p><!-- l. 24 --><p class='indent'>   The eBPF community is doing a great job documenting the system and
writing tutorials. I felt I could contribute to this effort by writing about
Arena.
   
</p>
   <h3 class='sectionHead' id='introduction'><span class='titlemark'>1   </span> <a id='x1-10001'></a>Introduction</h3>
<!-- l. 35 --><p class='noindent'>The Arena is a new MAP type (<span class='cmtt-10'>BPF_MAP_TYPE_ARENA</span>) available to eBPF programs
since kernel version 6.9. This map is semantically different than previous ones. Unlike
data-structure MAPs (e.g., hash, array, bloom, stack, …) Arena provides a direct
access to the kernel memory instead of abstracting it away. It increases the programs
expressivity and enables them to implement their own data-structures on-demand
(e.g, a specific type of tree).
</p><!-- l. 43 --><p class='indent'>   Three use-cases have been named for the Arena in the introduction message <span class='cite'>[<a href='#Xarenapatch'>13</a>]</span>
sent along its patch to the Linux mailing list. I summarize them below:
</p>
     <ul class='itemize1'>
     <li class='itemize'>User-space can use Arena’s memory to implement its own data-structures
     (it is a normal memory region), while the memory is visible to eBPF
     programs  which  can  implement  a  fast-path  for  operations  like  packet
     processing.
     </li>
     <li class='itemize'>Arena can be used as a communication channel between an eBPF and a
     user-space program.
     </li>
     <li class='itemize'>Arena can be used as a heap of memory for the eBPF program</li></ul>
<!-- l. 55 --><p class='noindent'>My understanding from these use-cases is that Arena provides access to raw pages of
memory shareable among eBPF programs and user-space. Each can decide to use it
as they see fit with their own responsibility. It is unlike other types of data-structure
MAPs that enforce certain constraints such as fixed key and value sizes, or limiting
the operations to lookup and update.
</p><!-- l. 61 --><p class='indent'>   In this tutorial, I explore Arena’s API, and provide some examples using it. I
hope this document helps others explore Arena and facilitate its development. The
example codes in this text are shared with you at <a href='https://github.com/bpf-endeavor/ebpf-arena-tutorial' target='_blank'>this GitHub repository</a>. I’ve only
                                                                  

                                                                  
shared excerpts from the codes — The parts I thought was important. You may find
and read the full examples in the repository.
   
</p>
   <h3 class='sectionHead' id='arenas-api'><span class='titlemark'>2   </span> <a id='x1-20002'></a>Arena’s API</h3>
   
   <h4 class='subsectionHead' id='declare-a-map'><span class='titlemark'>2.1   </span> <a id='x1-30002.1'></a>Declare a MAP</h4>
<!-- l. 72 --><p class='noindent'>A program can declare the Arena MAP similar to other MAPs. See Listing <a href='#example-of-using-arena-map'>1<!-- tex4ht:ref: lst:map_ex  --></a> for an
example. Here are some notes to keep in mind. The key size and value sizes must be
zero. The “<span class='cmtt-10'>max_entries</span>” field defines the maximum number of pages for the map,
and must be non-zero. As any other map, the maximum size is limited to 4 GB. At
the time of writing this text, Arena map declaration supports three flags <span class='cite'>[<a href='#Xarena_source'>5</a>]</span>:
</p>
     <ul class='itemize1'>
     <li class='itemize'><span class='cmtt-10'>BPF_F_MMAPABLE</span>:  Always  required.  Indicates  the  map  should  support
     memory mapping.
     </li>
     <li class='itemize'><span class='cmtt-10'>BPF_F_SEGV_ON_FAULT</span>: The user-space program will receive a <span class='cmtt-10'>SEGFAULT</span>
     signal if the memory is not mapped by the eBPF program (e.g., out of
     range access on a list created by the eBPF program).
     </li>
     <li class='itemize'><span class='cmtt-10'>BPF_F_NO_USER_CONV</span>: The memory region is private to the eBPF program
     and user-space program will not access it. This allows the JIT to perform
     optimizations avoiding address space casting (more about it later).</li></ul>
<!-- l. 89 --><p class='noindent'><span style='color:#808080;'>note: The <span class='cmitt-10'>BPF_F_MMAPABLE </span>must always be present.</span>
                                                                  

                                                                  
</p><!-- l. 93 --><p class='noindent' id='example-of-using-arena-map'><a id='x1-3016r1'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb1'><a id='x1-3007r1'></a><span style='color:#008000;'><span class='cmtt-10'>struct</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>{</span> 
<a id='x1-3009r2'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>__uint(type,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>BPF_MAP_TYPE_ARENA);</span> 
<a id='x1-3011r3'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>__uint(map_flags,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>BPF_F_MMAPABLE);</span> 
<a id='x1-3013r4'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>__uint(max_entries,</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>2</span></span><span class='cmtt-10'>);</span><span style='color:#BABABA;'> </span><span style='color:#3D7A7A;'><span class='cmitt-10'>/* number of pages */</span></span> 
<a id='x1-3015r5'></a><span class='cmtt-10'>}</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>arena</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>SEC(</span><span style='color:#BA2121;'><span class='cmtt-10'>".maps"</span></span><span class='cmtt-10'>);</span></pre>
<figcaption class='caption'><span class='id'>Listing 1: </span><span class='content'>Example of using Arena map.</span></figcaption><!-- tex4ht:label?: x1-3016r1  -->
                                                                  

                                                                  
</figure>

<h4 class='subsectionHead' id='helper-functions'><span class='titlemark'>2.2   </span> <a id='x1-40002.2'></a>Helper functions</h4>
<!-- l. 105 --><p class='noindent'>Normal eBPF MAP helpers such as “<span class='cmtt-10'>bpf_map_lookup_elem</span>” are not defined for
Arena <span class='cite'>[<a href='#Xarena_source'>5</a>]</span>. Instead the following pair of functions are available: </p>
     <ul class='itemize1'>
     <li class='itemize'><span class='cmtt-10'>bpf_arena_alloc_pages</span>: Allocates a memory page
     </li>
     <li class='itemize'><span class='cmtt-10'>bpf_arena_free_pages</span>: Frees the memory page</li></ul>
<!-- l. 113 --><p class='noindent'>These functions are defined using kfunc <span class='cite'>[<a href='#Xeunomia_kfunc'>4</a>, <a href='#Xebpf_docs_kfunc'>2</a>]</span>. As required by kfunc subsystem, you
should declare the signature of these helpers in your eBPF program to use these
functions.
                                                                  

                                                                  
</p><!-- l. 117 --><p class='noindent' id='functions-operating-on-arena-map'><a id='x1-4013r2'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb2'><a id='x1-4006r1'></a><span style='color:#B00040;'><span class='cmtt-10'>void</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>__arena</span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span style='color:#BABABA;'> </span><span style='color:#0000FF;'><span class='cmtt-10'>bpf_arena_alloc_pages</span></span><span class='cmtt-10'>(</span><span style='color:#B00040;'><span class='cmtt-10'>void</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>map,</span><span style='color:#BABABA;'> </span><span style='color:#B00040;'><span class='cmtt-10'>void</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>__arena</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>addr,</span> 
<a id='x1-4008r2'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>__u32</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>page_cnt,</span><span style='color:#BABABA;'> </span><span style='color:#B00040;'><span class='cmtt-10'>int</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>node_id,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>__u64</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>flags)</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>__ksym;</span> 
<a id='x1-4010r3'></a><span style='color:#B00040;'><span class='cmtt-10'>void</span></span><span style='color:#BABABA;'> </span><span style='color:#0000FF;'><span class='cmtt-10'>bpf_arena_free_pages</span></span><span class='cmtt-10'>(</span><span style='color:#B00040;'><span class='cmtt-10'>void</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>map,</span><span style='color:#BABABA;'> </span><span style='color:#B00040;'><span class='cmtt-10'>void</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>__arena</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>ptr,</span> 
<a id='x1-4012r4'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>__u32</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>page_cnt)</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>__ksym;</span></pre>
<figcaption class='caption'><span class='id'>Listing 2: </span><span class='content'>Functions operating on Arena MAP.</span></figcaption><!-- tex4ht:label?: x1-4013r2  -->
                                                                  

                                                                  
</figure>
<!-- l. 127 --><p class='noindent'>Calling these functions may put the thread to sleep. For this reason the functions
are marked with <span class='cmtt-10'>KF_SLEEPABLE</span> <span class='cite'>[<a href='#Xarena_source'>5</a>]</span>, and the verifier only allows sleepable
eBPF programs to use them. An eBPF program has sleeping privilege if the
<span class='cmtt-10'>BPF_F_SLEEPABLE </span>flag was set when loading it (see Listing <a href='#user-space-program-loading-the-program'>4<!-- tex4ht:ref: lst:loader  --></a> for an example). Not all
eBPF hooks support this flag. A list of sleepable hooks are provided in libbpf
documentations <span class='cite'>[<a href='#Xlibbpf_sleepable'>9</a>]</span>.
</p><!-- l. 136 --><p class='noindent'><span style='color:#808080;'>note: The memory pages allocated use the following flags: <span class='cmitt-10'>GFP_KERNEL</span>, <span class='cmitt-10'>__GFP_ZERO</span>,
<span class='cmitt-10'>__GFP_ACCOUNT</span>.</span>

</p>
<h4 class='subsectionHead' id='managing-two-address-spaces'><span class='titlemark'>2.3   </span> <a id='x1-50002.3'></a>Managing two address spaces</h4>
<!-- l. 140 --><p class='noindent'>Clang compiler, the verifier, the JIT, and the runtime all work together to make sure
the eBPF program accesses the correct memory address. When using Arena, there is
a translation between the user address space and kernel address space (unless the
map is declared with “<span class='cmtt-10'>BPF_F_NO_USER_CONV</span>” flag present). The eBPF program must
mark the pointers with “<span class='cmtt-10'>__attribute__((address_space(1)))</span>” to let the Clang
know about it and cause the generation of “<span class='cmtt-10'>bpf_arena_cast_user/kern</span>”
instructions. The “<span class='cmtt-10'>__arena</span>” tag used in the examples (and the accompanying
repository), especially when declaring variables and parameters, serves this
purpose.

</p>
<h3 class='sectionHead' id='examples'><span class='titlemark'>3   </span> <a id='x1-60003'></a>Examples</h3>
<!-- l. 155 --><p class='noindent'>I try to demonstrate how these APIs can be used to implement the use-cases named
above.

</p>
<h4 class='subsectionHead' id='memory-shared-among-ebpf-and-userspace'><span class='titlemark'>3.1   </span> <a id='x1-70003.1'></a>Memory shared among eBPF and user-space</h4>
<!-- l. 160 --><p class='noindent'>As a first step, let us demonstrate how to share a counter between an eBPF and an
user-space program. For the sake of example, I used an eBPF program of type
<span class='cmtt-10'>BPF_PROT_TYPE_SYSCALL</span> <span class='cite'>[<a href='#Xebpf_docs_prog_syscall'>11</a>]</span> which does not need to be attached to a hook and
can simply be invoked using a system call (for more information search for
<span class='cmtt-10'>BPF_PROG_TEST_RUN</span> <span class='cite'>[<a href='#Xebpf_docs_bpf_prog_run'>10</a>]</span>).
</p><!-- l. 166 --><p class='noindent'>Listing <a href='#an-ebpf-program-using-arena'>3<!-- tex4ht:ref: lst:mogu  --></a> shows the code for the example program. In this program, a global variable
(“<span class='cmtt-10'>flag_initialized</span>”) tracks whether it is the first time the program is executed or
not. In the first run, a page is allocated (using “<span class='cmtt-10'>bpf_arena_alloc_pages</span>”) and its
address is kept in “<span class='cmtt-10'>mem</span>” global variable. The allocated memory will hold a counter
                                                                  

                                                                  
keeping the number of invocations.
</p><!-- l. 174 --><p class='noindent'><span style='color:#808080;'>note: The global variable support is available since kernel version 5.2 <span class='cite'>[<a href='#Xglb_var_post'>1</a>]</span>.</span>
                                                                  

                                                                  
</p><!-- l. 177 --><p class='noindent' id='an-ebpf-program-using-arena'><a id='x1-7073r3'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb3'><a id='x1-7026r1'></a><span style='color:#3D7A7A;'><span class='cmitt-10'>/* Declaration of Arena MAP as in Listing 1 ... */</span></span> 
<a id='x1-7028r2'></a><span style='color:#008000;'><span class='cmtt-10'>static</span></span><span style='color:#BABABA;'> </span><span style='color:#B00040;'><span class='cmtt-10'>bool</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>flag_initialized</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>false</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7030r3'></a><span class='cmtt-10'>__arena</span><span style='color:#BABABA;'> </span><span style='color:#B00040;'><span class='cmtt-10'>void</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>mem</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7032r4'></a><span class='cmtt-10'>SEC(</span><span style='color:#BA2121;'><span class='cmtt-10'>"syscall"</span></span><span class='cmtt-10'>)</span> 
<a id='x1-7034r5'></a><span style='color:#B00040;'><span class='cmtt-10'>int</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>mogu(</span><span style='color:#B00040;'><span class='cmtt-10'>void</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>_)</span> 
<a id='x1-7036r6'></a><span class='cmtt-10'>{</span> 
<a id='x1-7038r7'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>bpf_printk(</span><span style='color:#BA2121;'><span class='cmtt-10'>"mogu: hello</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7040r8'></a><span style='color:#BABABA;'>    </span><span style='color:#008000;'><span class='cmtt-10'>if</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>(</span><span style='color:#666666;'><span class='cmtt-10'>!</span></span><span class='cmtt-10'>flag_initialized)</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>{</span> 
<a id='x1-7042r9'></a><span style='color:#BABABA;'>        </span><span class='cmtt-10'>mem</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>bpf_arena_alloc_pages(</span><span style='color:#666666;'><span class='cmtt-10'>&amp;</span></span><span class='cmtt-10'>arena,</span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>,</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>NUMA_NO_NODE,</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7044r10'></a><span style='color:#BABABA;'>        </span><span style='color:#008000;'><span class='cmtt-10'>if</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>(mem</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>==</span></span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>)</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>{</span> 
<a id='x1-7046r11'></a><span style='color:#BABABA;'>            </span><span class='cmtt-10'>bpf_printk(</span><span style='color:#BA2121;'><span class='cmtt-10'>"Failed to allocate memory"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7048r12'></a><span style='color:#BABABA;'>            </span><span style='color:#008000;'><span class='cmtt-10'>return</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7050r13'></a><span style='color:#BABABA;'>        </span><span class='cmtt-10'>}</span> 
<a id='x1-7052r14'></a><span style='color:#BABABA;'>        </span><span class='cmtt-10'>flag_initialized</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>true</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7054r15'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>}</span> 
<a id='x1-7056r16'></a><span style='color:#BABABA;'>    </span><span style='color:#008000;'><span class='cmtt-10'>if</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>(mem</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>==</span></span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>)</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>{</span> 
<a id='x1-7058r17'></a><span style='color:#BABABA;'>        </span><span style='color:#3D7A7A;'><span class='cmitt-10'>/* this branch must never happen! */</span></span> 
<a id='x1-7060r18'></a><span style='color:#BABABA;'>        </span><span style='color:#008000;'><span class='cmtt-10'>return</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7062r19'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>}</span> 
<a id='x1-7064r20'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>__arena</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>entry_t</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>e</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>mem;</span> 
<a id='x1-7066r21'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>e</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>counter</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>+=</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7068r22'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>bpf_printk(</span><span style='color:#BA2121;'><span class='cmtt-10'>"counter: %lld</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>e</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>counter);</span> 
<a id='x1-7070r23'></a><span style='color:#BABABA;'>    </span><span style='color:#008000;'><span class='cmtt-10'>return</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7072r24'></a><span class='cmtt-10'>}</span></pre>
<figcaption class='caption'><span class='id'>Listing 3: </span><span class='content'>An eBPF program using Arena.</span></figcaption><!-- tex4ht:label?: x1-7073r3  -->
                                                                  

                                                                  
</figure>
<!-- l. 207 --><p class='noindent'>Next, in Listing <a href='#user-space-program-loading-the-program'>4<!-- tex4ht:ref: lst:loader  --></a>, we see how user-space program loads the eBPF program and
Listing <a href='#userspace-accessing-the-memory-page-allocated-from-arena'>5<!-- tex4ht:ref: lst:loader_read  --></a> shows it accessing the counter on the Arena memory page (The user-space
relies on libbpf and its skeleton framework <span class='cite'>[<a href='#Xlibbpf_skeleton'>6</a>]</span>).
                                                                  

                                                                  
</p><!-- l. 213 --><p class='noindent' id='user-space-program-loading-the-program'><a id='x1-7191r4'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb4'><a id='x1-7114r1'></a><span style='color:#3D7A7A;'><span class='cmitt-10'>/* Some global vars */</span></span> 
<a id='x1-7116r2'></a><span style='color:#008000;'><span class='cmtt-10'>static</span></span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>volatile</span></span><span style='color:#BABABA;'> </span><span style='color:#B00040;'><span class='cmtt-10'>int</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>running</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7118r3'></a><span style='color:#008000;'><span class='cmtt-10'>static</span></span><span style='color:#BABABA;'> </span><span style='color:#B00040;'><span class='cmtt-10'>int</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>ebpf_prog_fd</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>-1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7120r4'></a><span style='color:#008000;'><span class='cmtt-10'>static</span></span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>struct</span></span><span style='color:#BABABA;'> </span><span style='color:#0000FF;'><span class='cmtt-10'>mogu</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>skel</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7122r5'></a> 
<a id='x1-7124r6'></a><span style='color:#B00040;'><span class='cmtt-10'>int</span></span><span style='color:#BABABA;'> </span><span style='color:#0000FF;'><span class='cmtt-10'>main</span></span><span class='cmtt-10'>(</span><span style='color:#B00040;'><span class='cmtt-10'>int</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>argc,</span><span style='color:#BABABA;'> </span><span style='color:#B00040;'><span class='cmtt-10'>char</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>argv[])</span> 
<a id='x1-7126r7'></a><span class='cmtt-10'>{</span> 
<a id='x1-7128r8'></a><span class='cmtt-10'>skel</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>mogu__open();</span> 
<a id='x1-7130r9'></a><span style='color:#008000;'><span class='cmtt-10'>if</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>(</span><span style='color:#666666;'><span class='cmtt-10'>!</span></span><span class='cmtt-10'>skel)</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>{</span> 
<a id='x1-7132r10'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>fprintf(stderr,</span><span style='color:#BABABA;'> </span><span style='color:#BA2121;'><span class='cmtt-10'>"Failed to open the skeleton</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7134r11'></a><span style='color:#BABABA;'>    </span><span style='color:#008000;'><span class='cmtt-10'>return</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>EXIT_FAILURE;</span> 
<a id='x1-7136r12'></a><span class='cmtt-10'>}</span> 
<a id='x1-7138r13'></a><span style='color:#3D7A7A;'><span class='cmitt-10'>/* Set sleepable flag */</span></span> 
<a id='x1-7140r14'></a><span class='cmtt-10'>bpf_program__set_flags(skel</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>progs.mogu,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>BPF_F_SLEEPABLE);</span> 
<a id='x1-7142r15'></a><span style='color:#008000;'><span class='cmtt-10'>if</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>(mogu__load(skel))</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>{</span> 
<a id='x1-7144r16'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>fprintf(stderr,</span><span style='color:#BABABA;'> </span><span style='color:#BA2121;'><span class='cmtt-10'>"Failed to load eBPF program</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7146r17'></a><span style='color:#BABABA;'>    </span><span style='color:#008000;'><span class='cmtt-10'>return</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>EXIT_FAILURE;</span> 
<a id='x1-7148r18'></a><span class='cmtt-10'>}</span> 
<a id='x1-7150r19'></a> 
<a id='x1-7152r20'></a><span class='cmtt-10'>ebpf_prog_fd</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>bpf_program__fd(skel</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>progs.mogu);</span> 
<a id='x1-7154r21'></a><span style='color:#3D7A7A;'><span class='cmitt-10'>/* It will invoke the eBPF program for the first time */</span></span> 
<a id='x1-7156r22'></a><span class='cmtt-10'>handle_invoke_signal(</span><span style='color:#666666;'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7158r23'></a> 
<a id='x1-7160r24'></a><span style='color:#3D7A7A;'><span class='cmitt-10'>/* Keep running and handle signals */</span></span> 
<a id='x1-7162r25'></a><span class='cmtt-10'>running</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7164r26'></a><span class='cmtt-10'>signal(SIGINT,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>handle_signal);</span> 
<a id='x1-7166r27'></a><span class='cmtt-10'>signal(SIGHUP,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>handle_signal);</span> 
<a id='x1-7168r28'></a><span class='cmtt-10'>signal(SIGUSR1,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>handle_invoke_signal);</span> 
<a id='x1-7170r29'></a><span class='cmtt-10'>printf(</span><span style='color:#BA2121;'><span class='cmtt-10'>"Hit Ctrl+C to terminate ...</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7172r30'></a><span class='cmtt-10'>printf(</span><span style='color:#BA2121;'><span class='cmtt-10'>"Invoke eBPF program:</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7174r31'></a><span class='cmtt-10'>printf(</span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\t</span></span><span style='color:#BA2121;'><span class='cmtt-10'>Mogu: pkill -SIGUSR1 mogu_loader</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7176r32'></a> 
<a id='x1-7178r33'></a><span style='color:#008000;'><span class='cmtt-10'>while</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>(running)</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>{</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>pause();</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>}</span> 
<a id='x1-7180r34'></a> 
<a id='x1-7182r35'></a><span class='cmtt-10'>mogu__detach(skel);</span> 
<a id='x1-7184r36'></a><span class='cmtt-10'>mogu__destroy(skel);</span> 
<a id='x1-7186r37'></a><span class='cmtt-10'>printf(</span><span style='color:#BA2121;'><span class='cmtt-10'>"Done!</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7188r38'></a><span style='color:#008000;'><span class='cmtt-10'>return</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7190r39'></a><span class='cmtt-10'>}</span></pre>
<figcaption class='caption'><span class='id'>Listing 4: </span><span class='content'>User space program loading the program</span></figcaption><!-- tex4ht:label?: x1-7191r4  -->
                                                                  

                                                                  
</figure>
                                                                  

                                                                  
<!-- l. 259 --><p class='noindent' id='userspace-accessing-the-memory-page-allocated-from-arena'><a id='x1-7210r5'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb5'><a id='x1-7199r1'></a><span class='cmtt-10'>entry_t</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>e</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>skel</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>bss</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>mem;</span> 
<a id='x1-7201r2'></a><span style='color:#008000;'><span class='cmtt-10'>if</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>(e</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>==</span></span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>)</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>{</span> 
<a id='x1-7203r3'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>printf(</span><span style='color:#BA2121;'><span class='cmtt-10'>"NOTE: the initialization was not successful!</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-7205r4'></a><span style='color:#BABABA;'>    </span><span style='color:#008000;'><span class='cmtt-10'>return</span></span><span class='cmtt-10'>;</span> 
<a id='x1-7207r5'></a><span class='cmtt-10'>}</span> 
<a id='x1-7209r6'></a><span class='cmtt-10'>printf(</span><span style='color:#BA2121;'><span class='cmtt-10'>"user: counter=%lld</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>e</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>counter);</span></pre>
<figcaption class='caption'><span class='id'>Listing 5: </span><span class='content'>User-space accessing the memory page allocated from Arena</span></figcaption><!-- tex4ht:label?: x1-7210r5  -->
                                                                  

                                                                  
</figure>

<h4 class='subsectionHead' id='using-arena-in-xdp-or-other-hooks-that-can-not-sleep'><span class='titlemark'>3.2   </span> <a id='x1-80003.2'></a>Using Arena in XDP (or other hooks that can not sleep)</h4>
<!-- l. 274 --><p class='noindent'>As was mentioned, Arena memory allocation helper functions may put the calling
thread to sleep. This is not acceptable for programs attached to hooks such as XDP.
But, this limitation does not mean that XDP programs can not access the Arena
memory. They just can not allocate or free the pages.
</p><!-- l. 279 --><p class='noindent'>For the next step, Let us share the memory page allocated by the program from the
previous example with another eBPF program. This allows the second program to
use Arena backed memory pages without allocating memory itself. Listing <a href='#an-ebpf-program-that-uses-arena-pages-allocated-from-another-program'>6<!-- tex4ht:ref: lst:aloe  --></a> shows
the second eBPF program.
</p><!-- l. 284 --><p class='noindent'>Here are some details that I like to bring to your attention:
     </p><ol class='enumerate1'>
<li class='enumerate' id='x1-8002x1'>Notice that both eBPF programs declare an Arena (as shown in Listing <a href='#example-of-using-arena-map'>1<!-- tex4ht:ref: lst:map_ex  --></a>).
     The loader (will be discussed next) will make sure both are using the same
     MAP using the libbpf’s <span class='cmtt-10'>bpf_map__reuse_fd </span>helper.
     </li>
<li class='enumerate' id='x1-8004x2'>The second program expects the loader to pass the address of allocated
     page through its global variable called “mem”. This address could have
     been shared among the two program in other ways, e.g. through a shared
     array MAP.
     </li>
<li class='enumerate' id='x1-8006x3'>The   second   program   is   using   a   non-standard   helper   named
     “<span class='cmtt-10'>my_kfunc_reg_arena</span>”. This function (a kfunc defined by me) does not
     perform any operation. Its sole role is to let the verifier recognize that the
     program is using the Arena. See <span class='tcrm-1000'>§</span><a href='#why-do-we-need-a-custom-arena-function'>3.2.1<!-- tex4ht:ref: sec:need_custom  --></a> for more detail.</li></ol>
                                                                  

                                                                  
<!-- l. 302 --><p class='noindent' id='an-ebpf-program-that-uses-arena-pages-allocated-from-another-program'><a id='x1-8064r6'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb6'><a id='x1-8027r1'></a><span style='color:#3D7A7A;'><span class='cmitt-10'>/* Declaration of Arena MAP as in Listing 1 ... */</span></span> 
<a id='x1-8029r2'></a><span class='cmtt-10'>__arena</span><span style='color:#BABABA;'> </span><span style='color:#B00040;'><span class='cmtt-10'>void</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>mem</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>;</span> 
<a id='x1-8031r3'></a> 
<a id='x1-8033r4'></a><span style='color:#3D7A7A;'><span class='cmitt-10'>/* Load the kernel module for adding this kfunc */</span></span> 
<a id='x1-8035r5'></a><span style='color:#B00040;'><span class='cmtt-10'>long</span></span><span style='color:#BABABA;'> </span><span style='color:#0000FF;'><span class='cmtt-10'>my_kfunc_reg_arena</span></span><span class='cmtt-10'>(</span><span style='color:#B00040;'><span class='cmtt-10'>void</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>p__map)</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>__ksym;</span> 
<a id='x1-8037r6'></a> 
<a id='x1-8039r7'></a><span class='cmtt-10'>SEC(</span><span style='color:#BA2121;'><span class='cmtt-10'>"syscall"</span></span><span class='cmtt-10'>)</span> 
<a id='x1-8041r8'></a><span style='color:#B00040;'><span class='cmtt-10'>int</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>aloe_main(</span><span style='color:#B00040;'><span class='cmtt-10'>void</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>_)</span> 
<a id='x1-8043r9'></a><span class='cmtt-10'>{</span> 
<a id='x1-8045r10'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>my_kfunc_reg_arena(</span><span style='color:#666666;'><span class='cmtt-10'>&amp;</span></span><span class='cmtt-10'>arena_map);</span> 
<a id='x1-8047r11'></a><span style='color:#BABABA;'>    </span><span style='color:#008000;'><span class='cmtt-10'>if</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>(mem</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>==</span></span><span style='color:#BABABA;'> </span><span style='color:#008000;'><span class='cmtt-10'>NULL</span></span><span class='cmtt-10'>)</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>{</span> 
<a id='x1-8049r12'></a><span style='color:#BABABA;'>        </span><span class='cmtt-10'>bpf_printk(</span><span style='color:#BA2121;'><span class='cmtt-10'>"aloe: not seeing the memory!</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>);</span> 
<a id='x1-8051r13'></a><span style='color:#BABABA;'>        </span><span style='color:#008000;'><span class='cmtt-10'>return</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>1</span></span><span class='cmtt-10'>;</span> 
<a id='x1-8053r14'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>}</span> 
<a id='x1-8055r15'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>__arena</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>entry_t</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>*</span></span><span class='cmtt-10'>e</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>mem;</span> 
<a id='x1-8057r16'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>bpf_printk(</span><span style='color:#BA2121;'><span class='cmtt-10'>"aloe: counter=%lld</span></span><span style='color:#AB5C1F;'><span class='cmtt-10'>\n</span></span><span style='color:#BA2121;'><span class='cmtt-10'>"</span></span><span class='cmtt-10'>,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>e</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>counter);</span> 
<a id='x1-8059r17'></a><span style='color:#BABABA;'>    </span><span class='cmtt-10'>e</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>counter</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>+=</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>100</span></span><span class='cmtt-10'>;</span> 
<a id='x1-8061r18'></a><span style='color:#BABABA;'>    </span><span style='color:#008000;'><span class='cmtt-10'>return</span></span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>0</span></span><span class='cmtt-10'>;</span> 
<a id='x1-8063r19'></a><span class='cmtt-10'>}</span></pre>
<figcaption class='caption'><span class='id'>Listing 6: </span><span class='content'>An eBPF program that uses Arena pages allocated from another
program</span></figcaption><!-- tex4ht:label?: x1-8064r6  -->
                                                                  

                                                                  
</figure>
<!-- l. 327 --><p class='noindent'>To share the Arena from the first eBPF program (Listing <a href='#an-ebpf-program-using-arena'>3<!-- tex4ht:ref: lst:mogu  --></a>) with the second one
(Listing <a href='#an-ebpf-program-that-uses-arena-pages-allocated-from-another-program'>6<!-- tex4ht:ref: lst:aloe  --></a>), the loader (user-space) program has to mediate and pass the
reference from first program to the second. Listing <a href='#loader-program-assigning-the-arena-from-the-first-program-to-the-second-program'>7<!-- tex4ht:ref: lst:share-map-ref  --></a> shows an example of this
procedure.
                                                                  

                                                                  
</p><!-- l. 333 --><p class='noindent' id='loader-program-assigning-the-arena-from-the-first-program-to-the-second-program'><a id='x1-8077r7'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb7'><a id='x1-8070r1'></a><span style='color:#B00040;'><span class='cmtt-10'>int</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>arena_fd</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>bpf_map__fd(skel1</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>maps.arena);</span> 
<a id='x1-8072r2'></a><span class='cmtt-10'>bpf_map__reuse_fd(skel2</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>maps.arena_map,</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>arena_fd);</span> 
<a id='x1-8074r3'></a><span style='color:#3D7A7A;'><span class='cmitt-10'>/* Pass the pointer to the  second program */</span></span> 
<a id='x1-8076r4'></a><span class='cmtt-10'>skel2</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>bss</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>mem</span><span style='color:#BABABA;'> </span><span style='color:#666666;'><span class='cmtt-10'>=</span></span><span style='color:#BABABA;'> </span><span class='cmtt-10'>skel1</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>bss</span><span style='color:#666666;'><span class='cmtt-10'>-&gt;</span></span><span class='cmtt-10'>mem;</span></pre>
<figcaption class='caption'><span class='id'>Listing 7: </span><span class='content'>Loader program assigning the Arena from the first program to the
second program</span></figcaption><!-- tex4ht:label?: x1-8077r7  -->
                                                                  

                                                                  
</figure>

<h5 class='subsubsectionHead' id='why-do-we-need-a-custom-arena-function'><span class='titlemark'>3.2.1   </span> <a id='x1-90003.2.1'></a>Why do we need a custom Arena function?</h5>
<!-- l. 345 --><p class='noindent'>If we remove the call to the non-standard <span class='cmtt-10'>my_kfunc_reg_arena </span>in Listing <a href='#an-ebpf-program-that-uses-arena-pages-allocated-from-another-program'>6<!-- tex4ht:ref: lst:aloe  --></a>,
although the program would compile, the verifier will complain that the program
does not have any associated Arena map, but is trying to use Arena memory
addressing. The error message from verifier is as follows:
                                                                  

                                                                  
</p><!-- l. 351 --><p class='noindent' id='verifier-error-message-when-the-arena-is-not-referenced-in-the-program'><a id='x1-9004r8'></a></p><figure class='float'>
                                                                  

                                                                  
<pre class='fancyvrb' id='fancyvrb8'><a id='x1-9003r1'></a><span class='cmtt-10'>addr_space_cast</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>insn</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>can</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>only</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>be</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>used</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>in</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>a</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>program</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>that</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>has</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>an</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>associated</span><span style='color:#BABABA;'> </span><span class='cmtt-10'>arena</span></pre>
<figcaption class='caption'><span class='id'>Listing 8: </span><span class='content'>Verifier error message when the Arena is not referenced in the program</span></figcaption><!-- tex4ht:label?: x1-9004r8  -->
                                                                  

                                                                  
</figure>
<!-- l. 358 --><p class='noindent'>Looking at the verifiers source code to decipher the error message, we see that the
error is raised when the program is not associated with an Arena while the program
has an address space cast instruction <span class='cite'>[<a href='#Xverifier_arena_not_set'>7</a>]</span> (exactly as written in the error
message).
</p><!-- l. 363 --><p class='noindent'>The association of an Arena MAP to a program happens when the it is referenced
(e.g., by using a helper function). Unfortunately, in the second program we
deliberately do not want to use Arena specific helpers. Other helper functions such
as <span class='cmtt-10'>bpf_map_lookup_elem </span>also cause other complains from the verifier (in
my test it complained due to attempting a zero byte read). Defining a new
helper that does nothing but still satisfies the verifier is a smart hack around
the situation. It showcases the flexibility that kfunc has brought to eBPF
ecosystem.
</p><!-- l. 373 --><p class='noindent'><span style='color:#808080;'>note: The idea of having a dummy helper was suggested by my lab-mate <a href='https://marcomole00.github.io/' target='_blank'>Marco
Mole</a>.</span>

</p>
<h4 class='subsectionHead' id='userspace-managed-datastructures'><span class='titlemark'>3.3   </span> <a id='x1-100003.3'></a>User-space managed data-structures</h4>
<!-- l. 378 --><p class='noindent'>In the third example, I demonstrate how user-space program can allocate pages of
Arena map (useful to implement its own custom data-structure). Since these
data-structures are on Arena pages, they will be accessible to eBPF programs sharing
the same Arena.
</p><!-- l. 383 --><p class='noindent'>We can use libbpf to get access to the Arena memory. The library has an API named
<span class='cmtt-10'>bpf_map__initial_value </span>(not well documented at the moment). As input, this
function receive a pointer to a MAP and a pointer to a 64-bit variable. The return
value is the address for the beginning of Arena memory region (mapped to the
user-space program memory address), also the 64-bit variable will be set to the size of
the currently allocated memory <span class='cite'>[<a href='#Xlibbpf_initial_value'>8</a>]</span>.
</p><!-- l. 391 --><p class='noindent'>To allocate memory pages, the user-space can cause page-faults by accessing memory
addresses in Arena. The page fault will notify the kernel to allocate the memory
page. For example, in our previous examples the Arena has two pages (see Listing <a href='#example-of-using-arena-map'>1<!-- tex4ht:ref: lst:map_ex  --></a>).
Assuming size of each page is 4 KB, the program can access the Arena memory (the
address we found using <span class='cmtt-10'>bpf_map__initial_value</span>) at offset 0 and 4096 to allocate
the two pages. Accessing the memory outside of the Arena region will cause a
<span class='cmtt-10'>SIGSEGV </span>(Address boundary error).
</p><!-- l. 400 --><p class='noindent'>The user-space program can use these memory pages to implement its own
data-structures in the Arena which is will be visible to eBPF programs.

</p>
<h3 class='sectionHead' id='final-notes'><span class='titlemark'>4   </span> <a id='x1-110004'></a>Final Notes</h3>
                                                                  

                                                                  
<!-- l. 406 --><p class='noindent'>The Arena feature is very new. It will probably change and improve. I am sure by the
time it is mature, eBPF community has written good documentation and tutorials on
it but meanwhile I hope this post fill the gap. It is important for me to say
that although I tried my best to share correct information, I can not claim
that I understand every aspect of Arena’s implementation. There may be
misunderstandings on my side. In such a case please let me know and accept my
apology.
</p><!-- l. 414 --><p class='noindent'>I want to conclude by listing some of the limitations of Arena that I observed looking
at the verifier and x86 JIT code.
</p><!-- l. 417 --><p class='noindent'>
     </p><ol class='enumerate1'>
<li class='enumerate' id='x1-11002x1'><span class='sout'>The  atomic  reads/writes  are  not  supported  in  Arena  memory  region.</span>
     At the moment, in Arena memory region, limited atomic operations are
     support from eBPF side <span class='cite'>[<a href='#Xarena_atomic'>15</a>]</span>.
     </li>
<li class='enumerate' id='x1-11004x2'>Arena pointer arithmetics are converted to 32 bit operations.
     </li>
<li class='enumerate' id='x1-11006x3'>There can be only one Arena map per program of maximum size of 4 GB.
     </li>
<li class='enumerate' id='x1-11008x4'>Program must be JIT compiled (it is almost always the case)
     </li>
<li class='enumerate' id='x1-11010x5'><span class='cmtt-10'>BPF_CAP </span>and <span class='cmtt-10'>CAP_PERFMON </span>is needed for loading a program with Arena
     </li>
<li class='enumerate' id='x1-11012x6'>Sign extending load instruction is not supported for Arena memory region
     </li>
<li class='enumerate' id='x1-11014x7'>The cast to address-space(1) will generate a “<span class='cmtt-10'>dst = (u32)src</span>”
                                                                  

                                                                  
     </li>
<li class='enumerate' id='x1-11016x8'>The cast lets the verifier know that the pointer is to arena the cast to
     address-space (0) turns the value into a scalar.
     </li>
<li class='enumerate' id='x1-11018x9'>x86 JIT uses the R12 register to track the start of Arena virtual address
     (it was unused before).</li></ol>

<h4 class='subsectionHead' id='updates'><span class='titlemark'>4.1   </span> <a id='x1-120004.1'></a>Updates</h4>
     <ul class='itemize1'>
     <li class='itemize'>
     <!-- l. 433 --><p class='noindent'>5<sup><span class='cmmi-7'>th</span></sup> July, 2025:
         </p><ol class='enumerate1'>
<li class='enumerate' id='x1-12002x1'>In Linux version 6.14 there is the possibility to associate a MAP to
         a program when using <span class='cmtt-10'>BPF_PROG_LOAD</span>, so there is no need to have
         the dummy helper function <span class='cite'>[<a href='#Xassociate_map_with_bpf'>12</a>]</span>.</li></ol>
     </li>
     <li class='itemize'>
     <!-- l. 437 --><p class='noindent'>1<sup><span class='cmmi-7'>st</span></sup> March, 2025:
         </p><ol class='enumerate1'>
<li class='enumerate' id='x1-12004x1'>Correction: Some atomic instructions available to eBPF programs to
         access Arena <span class='cite'>[<a href='#Xarena_atomic'>15</a>]</span> and others can be supported in the future by the
         JIT
         </li>
<li class='enumerate' id='x1-12006x2'>New  information:  There  are  on  going  work  to  support  memory
         allocation in non-sleepable programs (e.g., XDP) <span class='cite'>[<a href='#Xslub'>3</a>, <a href='#Xtry_alloc'>14</a>]</span>. Thanks to
         <a href='https://kkdwivedi.in/' target='_blank'>Kumar Kartikeya Dwivedi</a></li></ol>
     </li></ul>
<section class='thebibliography' role='doc-bibliography'>
                                                                  

                                                                  
<h3 class='likesectionHead' id='references'><a id='x1-13000'></a>References</h3>
<!-- l. 1 --><p class='noindent'>
    </p><dl><dt>
  [1]</dt><dd><a id='Xglb_var_post'></a>Johannes    Bechberger.          Hello    ebpf:    Global    variables.          
<a class='url' href='https://mostlynerdless.de/blog/2024/05/21/hello-ebpf-global-variables-10/'><span class='cmtt-10'>https://mostlynerdless.de/blog/2024/05/21/hello-ebpf-global-variables-10/</span></a>,
    2024.
    </dd><dt>
  [2]</dt><dd><a id='Xebpf_docs_kfunc'></a>Silvano  Cirujano Cuesta  and  Dylan  Reimerink.   ebpf  documentations:
    kfuncs. <a class='url' href='https://docs.ebpf.io/linux/concepts/kfuncs/'><span class='cmtt-10'>https://docs.ebpf.io/linux/concepts/kfuncs/</span></a>, 2024.
    </dd><dt>
  [3]</dt><dd><a id='Xslub'></a>Jonathan   Corbet.        What’s   next   for   the   slub   allocator.        
<a class='url' href='https://lwn.net/Articles/974138/'><span class='cmtt-10'>https://lwn.net/Articles/974138/</span></a>, 2024.
    </dd><dt>
  [4]</dt><dd><a id='Xeunomia_kfunc'></a>Extending  ebpf  beyond  its  limits:  Custom  kfuncs  in  kernel  modules.   
<a class='url' href='https://eunomia.dev/tutorials/43-kfuncs/'><span class='cmtt-10'>https://eunomia.dev/tutorials/43-kfuncs/</span></a>, 2024.
    </dd><dt>
  [5]</dt><dd><a id='Xarena_source'></a>Linux     source     tree:     Arena     map     implementation.              
<a class='url' href='https://elixir.bootlin.com/linux/v6.13.1/source/kernel/bpf/arena.c'><span class='cmtt-10'>https://elixir.bootlin.com/linux/v6.13.1/source/kernel/bpf/arena.c</span></a>.
    </dd><dt>
  [6]</dt><dd><a id='Xlibbpf_skeleton'></a>Kernel  documentations:  Libbpf  overview:  Bpf  object  skeleton  file.    
<a class='url' href='https://docs.kernel.org/bpf/libbpf/libbpf_overview.html#bpf-object-skeleton-file'><span class='cmtt-10'>https://docs.kernel.org/bpf/libbpf/libbpf_overview.html#bpf-object-skeleton-file</span></a>,
    2024.
    </dd><dt>
  [7]</dt><dd><a id='Xverifier_arena_not_set'></a>Linux   source   tree:   ebpf   verifier:   Checking   for   arena   map.       
<a class='url' href='https://elixir.bootlin.com/linux/v6.13.2/source/kernel/bpf/verifier.c#L14569'><span class='cmtt-10'>https://elixir.bootlin.com/linux/v6.13.2/source/kernel/bpf/verifier.c#L14569</span></a>.
    </dd><dt>
  [8]</dt><dd><a id='Xlibbpf_initial_value'></a>Libbpf          source:          bpf_map__initial_value.                            
<a class='url' href='https://github.com/libbpf/libbpf/blob/444f3c0e7a0fbfeeac4b3809a184c6640ce10306/src/libbpf.c#L10365'><span class='cmtt-10'>https://github.com/libbpf/libbpf/blob/444f3c0e7a0fbfeeac4b3809a184c6640ce10306/src/libbpf.c#L10365</span></a>,
    2024.
    </dd><dt>
  [9]</dt><dd><a id='Xlibbpf_sleepable'></a>Andrii     Nakryiko,     Donald     Hunter,     and     Daan     De Meyer.
    libbpf    documentation:    Program    types    and    elf    sections.          
<a class='url' href='https://github.com/libbpf/libbpf/blob/master/docs/program_types.rst'><span class='cmtt-10'>https://github.com/libbpf/libbpf/blob/master/docs/program_types.rst</span></a>.
    </dd><dt>
 [10]</dt><dd><a id='Xebpf_docs_bpf_prog_run'></a>Dylan
    Reimerink. ebpf documentations: Bpf syscall bpf_prog_test_run command.
    <a class='url' href='https://docs.ebpf.io/linux/syscall/BPF_PROG_TEST_RUN/'><span class='cmtt-10'>https://docs.ebpf.io/linux/syscall/BPF_PROG_TEST_RUN/</span></a>, 2023.
                                                                  

                                                                  
    </dd><dt>
 [11]</dt><dd><a id='Xebpf_docs_prog_syscall'></a>Dylan  Reimerink.     ebpf  documentations:  Bpf_prog_type_syscall.     
<a class='url' href='https://docs.ebpf.io/linux/program-type/BPF_PROG_TYPE_SYSCALL/'><span class='cmtt-10'>https://docs.ebpf.io/linux/program-type/BPF_PROG_TYPE_SYSCALL/</span></a>,
    2023.
    </dd><dt>
 [12]</dt><dd><a id='Xassociate_map_with_bpf'></a>Dylan Reimerink. Stackoverflow: addr˙space˙cast insn can only be used in
    a      program      that      has      an      associated      arena.                
<a class='url' href='https://stackoverflow.com/a/79564455/7510824'><span class='cmtt-10'>https://stackoverflow.com/a/79564455/7510824</span></a>, 2025.
    </dd><dt>
 [13]</dt><dd><a id='Xarenapatch'></a>Alex      Starovoitov.                Introduce      bpf      arena.                
<a class='url' href='https://lwn.net/Articles/961594/'><span class='cmtt-10'>https://lwn.net/Articles/961594/</span></a>, 2024.
    </dd><dt>
 [14]</dt><dd><a id='Xtry_alloc'></a>Alex       Starovoitov.                    [patch       bpf-next       v9       0/6]
    bpf,         mm:         Introduce         try˙alloc˙pages().                         
<a class='url' href='https://lore.kernel.org/bpf/20250222024427.30294-1-alexei.starovoitov@gmail.com/'><span class='cmtt-10'>https://lore.kernel.org/bpf/20250222024427.30294-1-alexei.starovoitov@gmail.com/</span></a>,
    2025.
    </dd><dt>
 [15]</dt><dd><a id='Xarena_atomic'></a>Alexei Starovoitov.  bpf: Add support for certain atomics in bpf˙arena to
    x86 jit. <a class='url' href='https://lwn.net/Articles/968703/'><span class='cmtt-10'>https://lwn.net/Articles/968703/</span></a>, 2024.
    </dd></dl>
</section>
 
</body> 
</html>